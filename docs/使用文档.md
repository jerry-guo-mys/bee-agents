# Bee 个人智能体系统 - 使用文档

## 一、快速开始

### 1.1 环境要求

- **Rust**: 1.70+（推荐使用 `rustup` 安装）
- **终端**: 需支持 TUI 的交互式终端（Terminal.app、iTerm2、Windows Terminal 等）

### 1.2 安装 Rust（如未安装）

```bash
curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
source $HOME/.cargo/env
```

### 1.3 构建与运行

```bash
# 克隆或进入项目目录
cd bee

# 构建（开发版）
cargo build

# 构建（发布版，推荐）
cargo build --release

# 运行
cargo run
# 或
./target/release/bee
```

> ⚠️ **重要**：请在**支持 TUI 的交互式终端**中运行，不要在 IDE 内嵌终端或 CI 环境运行，否则可能出现 `Device not configured` 错误。

---

## 二、环境配置

### 2.1 LLM 接入（必选其一）

Bee 支持三种 LLM 模式，按以下优先级选择：

| 优先级 | 环境变量 | 说明 |
|--------|----------|------|
| 1 | `DEEPSEEK_API_KEY` | 使用 DeepSeek 大模型（推荐） |
| 2 | `OPENAI_API_KEY` | 使用 OpenAI 兼容 API |
| 3 | （无） | 使用 Mock LLM（本地测试，无需网络） |

### 2.2 使用 DeepSeek（推荐）

1. 前往 [DeepSeek 开放平台](https://platform.deepseek.com/) 注册并获取 API Key
2. 设置环境变量：

```bash
# macOS / Linux
export DEEPSEEK_API_KEY=sk-xxxxxxxxxxxxxxxx

# 可选：使用思考模式（适合复杂推理，响应较慢）
export DEEPSEEK_MODEL=deepseek-reasoner

# 运行
cargo run
```

### 2.3 使用 OpenAI 兼容 API

若未设置 `DEEPSEEK_API_KEY`，可设置 `OPENAI_API_KEY` 使用 OpenAI 或兼容服务：

```bash
export OPENAI_API_KEY=sk-xxxxxxxxxxxxxxxx
cargo run
```

### 2.4 Mock 模式（测试）

不设置任何 API Key 时，Bee 将使用 Mock LLM，无需网络即可测试界面与流程。Mock 会回显你的输入并模拟工具调用。

---

## 三、界面说明

### 3.1 界面布局

```
┌───────────────────────────────────────────────────── Bee │ Idle ─────┐
│ You: 你好，帮我看看 workspace 里有什么文件                               │
│ Bee: 正在执行 ls 工具...                                                │
│ Bee: workspace 目录下有: README.md, src/                               │
├─────────────────────────────────────────────────────────────────────────┤
│ > 输入你的消息，按 Enter 发送                                            │
└─────────────────────────────────────────────────────────────────────────┘
```

- **上方区域**：对话历史，显示用户 (You) 与助手 (Bee) 的交互
- **下方区域**：输入框，输入消息后按 Enter 发送

### 3.2 状态指示

标题栏右侧显示当前状态：

| 状态 | 说明 |
|------|------|
| Idle | 等待输入 |
| Thinking... | LLM 正在思考 |
| Streaming... | 正在流式输出 |
| cat / ls / echo | 正在执行对应工具 |
| Error | 出现错误 |

---

## 四、快捷键

| 快捷键 | 功能 |
|--------|------|
| **Enter** | 发送当前输入的消息 |
| **Backspace** | 删除输入内容 |
| **Ctrl+C** | 取消当前生成 / 停止 |
| **Ctrl+L** | 清空对话历史 |
| **Ctrl+Q** | 退出程序 |
| **/exit** 或 **exit** | 输入后按 Enter 退出 |

---

## 五、与 Agent 对话

### 5.1 基本对话

直接在输入框输入问题，按 Enter 发送。Bee 会理解你的意图并选择：

- **直接回答**：简单问题会直接回复
- **调用工具**：需要读文件、列目录时，会自动调用 `cat`、`ls` 等工具

### 5.2 示例对话

**查看 workspace 目录内容：**
```
你: workspace 里有什么文件？
Bee: [调用 ls 工具] → 返回文件列表 → 总结给你
```

**读取文件内容：**
```
你: 帮我读一下 workspace/README.md 的内容
Bee: [调用 cat 工具] → 返回文件内容 → 总结或回答
```

**综合任务：**
```
你: 帮我看看 workspace 里有没有 Rust 项目，如果有，main.rs 里写了什么
Bee: [调用 ls] → [调用 cat main.rs] → 分析并回答
```

---

## 六、工具说明

Bee 目前内置以下工具，Agent 会根据对话内容自动选择使用。

### 6.1 cat - 读取文件

- **用途**：读取 `workspace` 目录下的文件内容
- **参数**：`{"path": "文件路径"}`
- **示例**：`cat README.md`、`cat src/main.rs`

### 6.2 ls - 列出目录

- **用途**：列出 `workspace` 内的文件和子目录
- **参数**：`{"path": "目录路径"}`，默认当前目录 `.`
- **示例**：`ls .`、`ls src`

### 6.3 echo - 回显（测试）

- **用途**：回显文本，主要用于测试
- **参数**：`{"text": "任意文本"}`

### 6.4 沙箱安全

- 所有文件操作**仅限 `workspace` 目录**，无法访问上级或其他路径
- 路径校验使用 `strip_prefix`，防止如 `../../etc/passwd` 的越界访问

---

## 七、workspace 目录

`workspace` 是 Bee 可访问的沙箱工作目录。

### 7.1 目录位置

默认在项目根目录下的 `workspace/`：

```
bee/
├── workspace/     ← Agent 只能读写此目录
│   ├── README.md
│   └── src/
├── config/
└── ...
```

### 7.2 使用建议

- 将希望 Agent 读取的代码、文档等放入 `workspace/`
- 避免在 `workspace` 外放置敏感文件，Agent 无法访问

---

## 八、配置说明

### 8.1 配置文件

| 文件 | 说明 |
|------|------|
| `config/default.toml` | 应用主配置 |
| `config/prompts/system.txt` | 系统 Prompt（定义 Agent 角色与工具说明） |

### 8.2 主要配置项

**config/default.toml 示例：**

```toml
[app]
workspace_root = "./workspace"
max_context_turns = 20

[llm]
provider = "deepseek"
model = "deepseek-chat"

[tools]
filesystem_root = "./workspace"
tool_timeout_secs = 30
```

- `max_context_turns`：保留的最近对话轮数
- `tool_timeout_secs`：单次工具调用的超时时间（秒）

### 8.3 自定义 Prompt

编辑 `config/prompts/system.txt` 可修改 Agent 的默认行为和语气，例如：

```
You are Bee, 一个专业的 Rust 编程助手...
```

---

## 九、常见问题

### Q1: 运行报错 `Device not configured`

**原因**：当前终端不支持 TUI 的 raw 模式。

**解决**：在系统自带的 Terminal.app、iTerm2、Windows Terminal 等终端中运行 `cargo run`，避免使用 IDE 内嵌终端或 CI 环境。

### Q2: 提示 `OPENAI_API_KEY not set, using Mock LLM`

**原因**：未设置 `DEEPSEEK_API_KEY` 和 `OPENAI_API_KEY`。

**解决**：设置其中一个 API Key，例如：

```bash
export DEEPSEEK_API_KEY=sk-xxx
```

### Q3: Agent 无法读取某文件

**原因**：该文件不在 `workspace` 目录下，或路径不正确。

**解决**：将文件移动到 `workspace`，或使用相对于 `workspace` 的正确路径，例如 `src/main.rs` 而不是 `/absolute/path/main.rs`。

### Q4: 如何清空对话重新开始？

按 **Ctrl+L** 清空当前对话历史。

### Q5: 生成太慢或卡住怎么办？

按 **Ctrl+C** 取消当前生成，然后可以继续输入新消息。

---

## 十、日志与调试

Bee 使用 `tracing` 输出日志，可通过环境变量控制级别：

```bash
# 默认 info 级别
cargo run

# 显示更详细日志
RUST_LOG=debug cargo run

# 只显示 bee 相关日志
RUST_LOG=bee=debug cargo run
```

---

## 十一、获取帮助

- **架构设计**：参见 `docs/Rust个人智能体系统(Bee)-架构设计白皮书.md`
- **架构分析**：参见 `docs/ARCHITECTURE_ANALYSIS.md`
- **项目概览**：参见根目录 `README.md`
