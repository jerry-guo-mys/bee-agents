<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè¡Œä¸ºæ”¹è¿› - ç”Ÿäº§çº§å®æ—¶ç›‘æ§ä»ªè¡¨æ¿</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            padding: 20px 30px;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            font-size: 1.8em;
            background: linear-gradient(90deg, #60a5fa, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #22c55e;
            animation: pulse 2s infinite;
        }
        
        .status-dot.disconnected {
            background: #ef4444;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .container {
            padding: 30px;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: #1e293b;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #334155;
            transition: all 0.3s;
        }
        
        .metric-card:hover {
            border-color: #60a5fa;
            transform: translateY(-2px);
        }
        
        .metric-card.critical {
            border-color: #ef4444;
            background: linear-gradient(135deg, #1e293b 0%, #450a0a 100%);
        }
        
        .metric-card.warning {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #1e293b 0%, #451a03 100%);
        }
        
        .metric-label {
            color: #94a3b8;
            font-size: 0.9em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #f8fafc;
        }
        
        .metric-change {
            margin-top: 8px;
            font-size: 0.85em;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .positive { color: #22c55e; }
        .negative { color: #ef4444; }
        .neutral { color: #94a3b8; }
        
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: #1e293b;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #334155;
        }
        
        .chart-container h3 {
            color: #f8fafc;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        
        .chart-wrapper {
            position: relative;
            height: 300px;
        }
        
        .live-feed {
            background: #1e293b;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #334155;
        }
        
        .live-feed h3 {
            color: #f8fafc;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .live-indicator {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        
        .feed-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .feed-item {
            padding: 12px;
            border-bottom: 1px solid #334155;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
        }
        
        .feed-item:hover {
            background: #334155;
        }
        
        .feed-time {
            color: #64748b;
            font-size: 0.85em;
            font-family: monospace;
            min-width: 80px;
        }
        
        .feed-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .feed-status.success { background: #22c55e; }
        .feed-status.error { background: #ef4444; }
        
        .feed-content {
            flex: 1;
            overflow: hidden;
        }
        
        .feed-input {
            color: #e2e8f0;
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .feed-meta {
            color: #64748b;
            font-size: 0.8em;
            margin-top: 4px;
        }
        
        .feed-metrics {
            text-align: right;
            font-family: monospace;
            font-size: 0.85em;
        }
        
        .feed-time-value {
            color: #60a5fa;
        }
        
        .alert-banner {
            background: linear-gradient(135deg, #450a0a 0%, #7f1d1d 100%);
            border: 1px solid #ef4444;
            border-radius: 8px;
            padding: 16px 20px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-banner.show {
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .alert-icon {
            font-size: 1.5em;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: bold;
            color: #fca5a5;
        }
        
        .alert-message {
            color: #fecaca;
            font-size: 0.9em;
            margin-top: 4px;
        }
        
        .alert-close {
            background: none;
            border: none;
            color: #fecaca;
            cursor: pointer;
            font-size: 1.2em;
            padding: 4px;
        }
        
        .config-panel {
            background: #1e293b;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #334155;
            margin-top: 20px;
        }
        
        .config-panel h3 {
            color: #f8fafc;
            margin-bottom: 20px;
        }
        
        .config-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .form-group label {
            color: #94a3b8;
            font-size: 0.85em;
        }
        
        .form-group input {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 8px 12px;
            color: #e2e8f0;
            font-size: 0.9em;
        }
        
        .btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #475569;
        }
        
        .btn-secondary:hover {
            background: #64748b;
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .metric-value {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¤– AIè¡Œä¸ºæ”¹è¿› - ç”Ÿäº§çº§å®æ—¶ç›‘æ§</h1>
        <div class="connection-status">
            <div class="status-dot" id="statusDot"></div>
            <span id="statusText">å·²è¿æ¥</span>
        </div>
    </div>
    
    <div class="container">
        <!-- æŠ¥è­¦æ¨ªå¹… -->
        <div class="alert-banner" id="alertBanner">
            <div class="alert-icon">âš ï¸</div>
            <div class="alert-content">
                <div class="alert-title" id="alertTitle">æŠ¥è­¦</div>
                <div class="alert-message" id="alertMessage">æ¶ˆæ¯å†…å®¹</div>
            </div>
            <button class="alert-close" onclick="dismissAlert()">Ã—</button>
        </div>
        
        <!-- å…³é”®æŒ‡æ ‡ -->
        <div class="metrics-grid">
            <div class="metric-card" id="cardTotal">
                <div class="metric-label">ä»Šæ—¥äº¤äº’æ€»æ•°</div>
                <div class="metric-value" id="metricTotal">-</div>
                <div class="metric-change neutral">
                    <span>å®æ—¶æ›´æ–°</span>
                </div>
            </div>
            
            <div class="metric-card" id="cardSuccess">
                <div class="metric-label">æˆåŠŸç‡</div>
                <div class="metric-value" id="metricSuccess">-</div>
                <div class="metric-change neutral">
                    <span>ç›®æ ‡: >95%</span>
                </div>
            </div>
            
            <div class="metric-card" id="cardError">
                <div class="metric-label">é”™è¯¯ç‡</div>
                <div class="metric-value" id="metricError">-</div>
                <div class="metric-change neutral">
                    <span>ç›®æ ‡: <5%</span>
                </div>
            </div>
            
            <div class="metric-card">
                <div class="metric-label">å¹³å‡å“åº”æ—¶é—´</div>
                <div class="metric-value" id="metricResponse">-</div>
                <div class="metric-change neutral">
                    <span>æ¯«ç§’</span>
                </div>
            </div>
        </div>
        
        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3>ğŸ“Š å®æ—¶é”™è¯¯ç‡è¶‹åŠ¿</h3>
                <div class="chart-wrapper">
                    <canvas id="errorRateChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>âš¡ å“åº”æ—¶é—´åˆ†å¸ƒ</h3>
                <div class="chart-wrapper">
                    <canvas id="responseTimeChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>ğŸ¯ é”™è¯¯ç±»å‹åˆ†å¸ƒ</h3>
                <div class="chart-wrapper">
                    <canvas id="errorTypeChart"></canvas>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>ğŸ“ˆ 24å°æ—¶è¶‹åŠ¿</h3>
                <div class="chart-wrapper">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- å®æ—¶æµ -->
        <div class="live-feed">
            <h3>
                <span class="live-indicator"></span>
                å®æ—¶ä¼šè¯æµ
            </h3>
            <div class="feed-list" id="feedList">
                <!-- åŠ¨æ€æ’å…¥ -->
            </div>
        </div>
        
        <!-- é…ç½®é¢æ¿ -->
        <div class="config-panel">
            <h3>âš™ï¸ ç›‘æ§é…ç½®</h3>
            <div class="config-form">
                <div class="form-group">
                    <label>WebSocketæœåŠ¡å™¨åœ°å€</label>
                    <input type="text" id="wsUrl" value="ws://localhost:8765">
                </div>
                <div class="form-group">
                    <label>åˆ·æ–°é—´éš” (æ¯«ç§’)</label>
                    <input type="number" id="refreshInterval" value="1000" min="100" max="10000">
                </div>
                <div class="form-group" style="display: flex; align-items: end;">
                    <button class="btn" onclick="reconnect()">é‡æ–°è¿æ¥</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // WebSocketè¿æ¥
        let ws = null;
        let reconnectInterval = null;
        let charts = {};
        let sessionData = [];
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            const chartConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        x: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        },
                        y: {
                            grid: { color: '#334155' },
                            ticks: { color: '#94a3b8' }
                        }
                    }
                }
            };
            
            // é”™è¯¯ç‡å›¾è¡¨
            charts.errorRate = new Chart(document.getElementById('errorRateChart'), {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        label: 'é”™è¯¯ç‡ (%)',
                        data: [],
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'ç›®æ ‡çº¿ (5%)',
                        data: [],
                        borderColor: '#22c55e',
                        borderDash: [5, 5],
                        pointRadius: 0
                    }]
                }
            });
            
            // å“åº”æ—¶é—´å›¾è¡¨
            charts.responseTime = new Chart(document.getElementById('responseTimeChart'), {
                ...chartConfig,
                data: {
                    labels: [],
                    datasets: [{
                        label: 'å“åº”æ—¶é—´ (ms)',
                        data: [],
                        borderColor: '#60a5fa',
                        backgroundColor: 'rgba(96, 165, 250, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                }
            });
            
            // é”™è¯¯ç±»å‹é¥¼å›¾
            charts.errorType = new Chart(document.getElementById('errorTypeChart'), {
                type: 'doughnut',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { color: '#94a3b8' }
                        }
                    }
                },
                data: {
                    labels: ['æ„å›¾è¯¯è§£', 'å·¥å…·è¯¯ç”¨', 'è·¯å¾„é”™è¯¯', 'è¾“å‡ºä¸å½“'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#ef4444', '#f59e0b', '#eab308', '#3b82f6']
                    }]
                }
            });
            
            // 24å°æ—¶è¶‹åŠ¿
            charts.hourly = new Chart(document.getElementById('hourlyChart'), {
                ...chartConfig,
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'äº¤äº’æ•°',
                        data: Array(24).fill(0),
                        borderColor: '#a78bfa',
                        backgroundColor: 'rgba(167, 139, 250, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                }
            });
        }
        
        // è¿æ¥WebSocket
        function connect() {
            const wsUrl = document.getElementById('wsUrl').value;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('âœ“ WebSocketå·²è¿æ¥');
                updateConnectionStatus(true);
                
                // è¯·æ±‚åˆå§‹æ•°æ®
                ws.send(JSON.stringify({type: 'request_stats'}));
                ws.send(JSON.stringify({type: 'request_history', limit: 20}));
            };
            
            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleMessage(message);
            };
            
            ws.onclose = () => {
                console.log('âœ— WebSocketå·²æ–­å¼€');
                updateConnectionStatus(false);
                
                // è‡ªåŠ¨é‡è¿
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(() => {
                        console.log('å°è¯•é‡æ–°è¿æ¥...');
                        connect();
                    }, 5000);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocketé”™è¯¯:', error);
            };
        }
        
        // å¤„ç†æ¶ˆæ¯
        function handleMessage(message) {
            switch(message.type) {
                case 'initial_data':
                    updateDashboard(message.data);
                    break;
                case 'metrics_update':
                    handleNewMetrics(message.data);
                    if (message.alert) {
                        showAlert(message.alert);
                    }
                    break;
                case 'stats_update':
                    updateMetrics(message.data);
                    break;
                case 'history_update':
                    updateFeed(message.data);
                    break;
            }
        }
        
        // æ›´æ–°ä»ªè¡¨æ¿
        function updateDashboard(data) {
            updateMetrics(data.stats);
            updateFeed(data.recent_sessions);
            updateErrorDistribution(data.error_distribution);
        }
        
        // æ›´æ–°æŒ‡æ ‡å¡ç‰‡
        function updateMetrics(stats) {
            document.getElementById('metricTotal').textContent = stats.total_sessions || 0;
            document.getElementById('metricSuccess').textContent = (stats.success_rate || 0).toFixed(1) + '%';
            document.getElementById('metricError').textContent = (stats.error_rate || 0).toFixed(1) + '%';
            document.getElementById('metricResponse').textContent = (stats.avg_response_time || 0).toFixed(0);
            
            // æ ¹æ®é˜ˆå€¼æ›´æ–°å¡ç‰‡æ ·å¼
            const errorCard = document.getElementById('cardError');
            if (stats.error_rate > 5) {
                errorCard.classList.add('warning');
            } else {
                errorCard.classList.remove('warning');
            }
            
            const successCard = document.getElementById('cardSuccess');
            if (stats.success_rate < 95) {
                successCard.classList.add('warning');
            } else {
                successCard.classList.remove('warning');
            }
        }
        
        // å¤„ç†æ–°æŒ‡æ ‡
        function handleNewMetrics(data) {
            sessionData.push(data);
            if (sessionData.length > 50) sessionData.shift();
            
            // æ›´æ–°å›¾è¡¨
            const labels = sessionData.map(s => new Date(s.timestamp).toLocaleTimeString());
            const errorRates = sessionData.map(s => s.success ? 0 : 100);
            const responseTimes = sessionData.map(s => s.response_time_ms);
            
            charts.errorRate.data.labels = labels;
            charts.errorRate.data.datasets[0].data = errorRates;
            charts.errorRate.update('none');
            
            charts.responseTime.data.labels = labels;
            charts.responseTime.data.datasets[0].data = responseTimes;
            charts.responseTime.update('none');
            
            // æ›´æ–°å®æ—¶æµ
            addFeedItem(data);
            
            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            ws.send(JSON.stringify({type: 'request_stats'}));
        }
        
        // æ›´æ–°é”™è¯¯åˆ†å¸ƒ
        function updateErrorDistribution(distribution) {
            const data = [
                distribution['æ„å›¾è¯¯è§£'] || 0,
                distribution['å·¥å…·è¯¯ç”¨'] || 0,
                distribution['è·¯å¾„é”™è¯¯'] || 0,
                distribution['è¾“å‡ºä¸å½“'] || 0
            ];
            charts.errorType.data.datasets[0].data = data;
            charts.errorType.update();
        }
        
        // æ›´æ–°å®æ—¶æµ
        function updateFeed(sessions) {
            const feedList = document.getElementById('feedList');
            feedList.innerHTML = '';
            
            sessions.forEach(session => {
                addFeedItem(session);
            });
        }
        
        // æ·»åŠ feedé¡¹
        function addFeedItem(session) {
            const feedList = document.getElementById('feedList');
            const time = new Date(session.timestamp).toLocaleTimeString();
            
            const item = document.createElement('div');
            item.className = 'feed-item';
            item.innerHTML = `
                <div class="feed-time">${time}</div>
                <div class="feed-status ${session.success ? 'success' : 'error'}"></div>
                <div class="feed-content">
                    <div class="feed-input">${session.user_input || 'æ— è¾“å…¥'}</div>
                    <div class="feed-meta">æ„å›¾: ${session.intent || 'æœªçŸ¥'}</div>
                </div>
                <div class="feed-metrics">
                    <div class="feed-time-value">${session.response_time_ms}ms</div>
                </div>
            `;
            
            feedList.insertBefore(item, feedList.firstChild);
            
            // é™åˆ¶æ•°é‡
            while (feedList.children.length > 20) {
                feedList.removeChild(feedList.lastChild);
            }
        }
        
        // æ˜¾ç¤ºæŠ¥è­¦
        function showAlert(alert) {
            const banner = document.getElementById('alertBanner');
            document.getElementById('alertTitle').textContent = 
                alert.severity === 'critical' ? 'ä¸¥é‡æŠ¥è­¦' : 'è­¦å‘Š';
            document.getElementById('alertMessage').textContent = alert.message;
            
            banner.classList.add('show');
            
            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                dismissAlert();
            }, 5000);
        }
        
        // å…³é—­æŠ¥è­¦
        function dismissAlert() {
            document.getElementById('alertBanner').classList.remove('show');
        }
        
        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.classList.remove('disconnected');
                text.textContent = 'å·²è¿æ¥';
                clearInterval(reconnectInterval);
                reconnectInterval = null;
            } else {
                dot.classList.add('disconnected');
                text.textContent = 'å·²æ–­å¼€';
            }
        }
        
        // é‡æ–°è¿æ¥
        function reconnect() {
            if (ws) {
                ws.close();
            }
            connect();
        }
        
        // åˆå§‹åŒ–
        window.onload = () => {
            initCharts();
            connect();
        };
        
        // æ¸…ç†
        window.onbeforeunload = () => {
            if (ws) {
                ws.close();
            }
        };
    </script>
</body>
</html>
