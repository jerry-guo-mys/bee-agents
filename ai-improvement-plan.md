# AI助手行为改进实施方案

> 系统性解决6大改进领域，建立可执行、可验证的改进机制。

---

## 📑 目录

1. [意图理解增强机制](#1-意图理解增强机制)
2. [智能工具选择决策树](#2-智能工具选择决策树)
3. [项目结构感知工作流](#3-项目结构感知工作流)
4. [实用指导输出框架](#4-实用指导输出框架)
5. [错误处理与适应策略](#5-错误处理与适应策略)
6. [对话连贯性保护机制](#6-对话连贯性保护机制)
7. [实施验证清单](#7-实施验证清单)
8. [快速参考卡](#8-快速参考卡)

**相关文档：** [速查卡](../ai-quick-reference.md) | [自检清单](../ai-self-check-workflow.md) | [追踪表](../ai-improvement-tracking.md)

---

## 概述
本文档系统性解决6大改进领域，建立可执行、可验证的改进机制。

---

## 1. 意图理解增强机制 {#intent-understanding}

### 1.1 三阶确认法
**触发条件**: 任何非明确指令（没有具体文件路径/命令/参数的指令）

```
[第一阶 - 语义分析]
- 提取关键词
- 识别任务类型（查询/执行/创建/修改/删除）
- 判断明确性等级（1-5分）

[第二阶 - 上下文对齐]
- 检查是否延续上次对话
- 验证是否存在隐式依赖
- 确认时间/范围约束

[第三阶 - 主动澄清]
IF 明确性 < 3分 THEN
  提出澄清问题（最多1个）
ELSE IF 存在多种解释 THEN
  陈述理解 + 请求确认
ELSE
  直接执行
```

### 1.2 常见意图模式库
| 用户表述 | 实际意图 | 正确工具 |
|---------|---------|---------|
| "计算..." | 数学运算 | bash(bc/expr/python) |
| "查看..." | 文件内容 | read/cat |
| "找..." | 搜索 | grep/ast_grep |
| "继续" | 延续上次任务 | 对话历史分析 |
| "怎样/如何..." | 指导需求 | 结构化解释+示例 |
| "修复/解决..." | 错误修复 | 诊断→定位→修复 |

### 1.3 意图确认模板
```
理解确认：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
您的请求：[重新表述用户意图]
执行计划：[具体步骤]
预期结果：[输出描述]
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

确认执行？（是/否/需要调整）
```

---

## 2. 智能工具选择决策树 {#tool-selection}

### 2.1 任务分类→工具映射
```
任务类型识别
├── 信息查询
│   ├── 文件内容 → read / cat
│   ├── 目录结构 → glob / ls
│   ├── 代码搜索 → grep / ast_grep_search
│   └── 符号查找 → lsp_symbols / lsp_find_references
├── 计算/处理
│   ├── 数学运算 → bash(bc/expr/python)
│   ├── 文本处理 → bash(awk/sed) + read/write
│   └── 数据分析 → bash(python/pandas)
├── 文件操作
│   ├── 创建文件 → write
│   ├── 修改文件 → edit
│   ├── 批量修改 → ast_grep_replace
│   └── 删除文件 → bash(rm) [需确认]
├── 代码开发
│   ├── 查看定义 → lsp_goto_definition
│   ├── 重命名 → lsp_rename
│   ├── 诊断检查 → lsp_diagnostics
│   └── 架构探索 → task(explore)
├── 项目管理
│   ├── 版本控制 → skill(git-master)
│   ├── 依赖管理 → read(package.json/requirements.txt)
│   └── 构建测试 → bash(npm test/build)
└── 网络/外部
    ├── 网页内容 → webfetch / skill(dev-browser)
    ├── 搜索信息 → websearch / codesearch
    └── API文档 → context7_query-docs
```

### 2.2 工具选择检查清单
**每次选择工具前自问：**
- [ ] 这个任务的核心目标是什么？
- [ ] 是否需要读取信息后才能决定？
- [ ] 是否有专门为此设计的工具？
- [ ] 工具参数是否完整且正确？
- [ ] 执行范围是否过宽/过窄？

### 2.3 常见错误预防
| 错误场景 | 错误工具 | 正确工具 | 原因 |
|---------|---------|---------|------|
| 计算 2+2 | ls / glob | bash(bc) | 任务不匹配 |
| 传输文件 | ls | scp / rsync | 工具功能不匹配 |
| 查看CSS | ls | read / grep | 需要内容而非列表 |
| 修改配置 | write(覆盖) | edit(局部) | 避免数据丢失 |
| 批量重构 | edit(逐个) | ast_grep_replace | 效率低下 |

---

## 3. 项目结构感知工作流 {#project-awareness}

### 3.1 探索-验证-执行模式
```
[阶段1: 项目识别]
IF 路径未确认 THEN
  1. glob("*") - 查看根目录
  2. 识别项目类型（通过配置文件）
  3. 记录关键目录结构

[阶段2: 路径验证]
IF 目标文件路径包含假设 THEN
  1. bash(test -f / test -d) 验证存在性
  2. IF 不存在 THEN 搜索实际路径
  3. 更新路径假设

[阶段3: 谨慎执行]
  1. 执行前再次确认路径
  2. 破坏性操作前备份
  3. 执行后验证结果
```

### 3.2 项目类型识别表
| 配置文件 | 项目类型 | 关键目录 |
|---------|---------|---------|
| package.json | Node.js/npm | src/, dist/, node_modules/ |
| Cargo.toml | Rust | src/, target/ |
| requirements.txt/setup.py | Python | src/, venv/ |
| go.mod | Go | cmd/, pkg/, internal/ |
| pom.xml/build.gradle | Java/Maven/Gradle | src/main/, src/test/ |
| CMakeLists.txt | C/C++ CMake | src/, build/ |
| Dockerfile/docker-compose.yml | Docker | 上下文相关 |

### 3.3 路径探索工具链
```python
# 探索优先级（从高到低）
1. glob("{pattern}")        # 模式匹配查找
2. bash(find . -name "...") # 深度搜索
3. grep("pattern")          # 内容反向定位文件
4. lsp_symbols(query="...") # 符号搜索
```

---

## 4. 实用指导输出框架 {#practical-guidance}

### 4.1 四层指导模型
```
[第一层: 直接答案]
- 30秒内可执行的核心方案
- 代码示例（如果适用）
- 关键命令/步骤

[第二层: 详细解释]
- 为什么这样解决
- 每个步骤的目的
- 替代方案对比

[第三层: 最佳实践]
- 常见陷阱
- 性能考虑
- 安全建议

[第四层: 扩展资源]
- 官方文档链接
- 相关示例
- 进阶主题
```

### 4.2 实施指导检查清单
**提供指导时确保：**
- [ ] 包含可立即执行的代码/命令
- [ ] 说明前提条件
- [ ] 提供验证方法
- [ ] 标注潜在风险
- [ ] 给出回滚方案（如适用）

### 4.3 反例→正例对比
**❌ 不好的回答：**
> "你可以使用Docker来部署这个应用。"

**✅ 好的回答：**
> **部署方案：Docker**
> ```bash
> # 1. 创建Dockerfile
cat > Dockerfile << 'EOF'
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY . .
EXPOSE 3000
CMD ["node", "server.js"]
EOF

> # 2. 构建镜像
> docker build -t myapp:1.0 .

> # 3. 运行容器
> docker run -d -p 3000:3000 --name myapp myapp:1.0
> ```
> **验证：** `curl http://localhost:3000/health`
> **前提：** 已安装Docker，3000端口可用

---

## 5. 错误处理与适应策略 {#error-handling}

### 5.1 错误响应决策树
```
错误发生
├── 文件不存在 (ENOENT)
│   ├── 路径拼写错误？→ 搜索正确路径
│   ├── 需要创建？→ 确认后创建
│   └── 权限问题？→ 检查权限/切换用户
├── 命令失败 (exit != 0)
│   ├── 参数错误？→ 修正参数重试
│   ├── 依赖缺失？→ 安装依赖
│   └── 环境问题？→ 检查环境变量
├── 网络错误 (HTTP 4xx/5xx)
│   ├── 404？→ 检查URL/搜索替代源
│   ├── 403？→ 检查认证/权限
│   └── 超时？→ 重试/检查网络
├── 类型/语法错误
│   ├── LSP诊断 → 逐条修复
│   └── AST错误 → 检查语法结构
└── 未知错误
    ├── 收集完整错误信息
    ├── 尝试简化场景重现
    └── 如无法解决 → 咨询Oracle
```

### 5.2 自适应重试策略
| 错误类型 | 立即重试 | 修正后重试 | 切换方案 | 寻求帮助 |
|---------|---------|-----------|---------|---------|
| 网络超时 | ✓（最多2次） | ✓ | ✓ | |
| 文件锁定 | ✓（延迟1s） | | ✓ | |
| 权限拒绝 | | ✓ | ✓ | |
| 命令不存在 | | | ✓ | |
| 逻辑错误 | | ✓ | ✓ | ✓ |

### 5.3 错误报告模板
```
[错误摘要]
操作：[尝试执行的操作]
错误：[错误类型和信息]
上下文：[相关文件/环境]

[已尝试方案]
1. [方案1] - 结果：[成功/失败/原因]
2. [方案2] - 结果：[成功/失败/原因]

[需要的帮助]
- [ ] 确认需求理解
- [ ] 提供解决思路
- [ ] 直接给出解决方案
```

---

## 6. 对话连贯性保护机制 {#conversation-continuity}

### 6.1 上下文状态管理
```
对话状态跟踪：
├── 当前任务：[任务描述]
├── 上次操作：[操作类型/结果]
├── 待确认项：[需要用户确认的事项]
├── 已收集信息：[关键数据/发现]
└── 下一步计划：[预计操作]
```

### 6.2 模糊指令处理
**当用户说"继续"时：**
```
1. 回顾对话历史最后3轮
2. 识别上次未完成事项
3. 确认理解：
   "您是指继续[具体任务]吗？"
4. 获得确认后执行
```

**其他模糊指令：**
| 模糊表述 | 可能的意图 | 确认策略 |
|---------|-----------|---------|
| "再来一次" | 重复上步/重做 | 询问具体内容 |
| "换个方法" | 尝试替代方案 | 列出备选 |
| "就这样" | 确认/接受 | 复述确认 |
| "等等" | 暂停/有问题 | 询问原因 |

### 6.3 对话断点保护
- **长任务**: 每5分钟报告进度
- **多步骤**: 每完成一步简要总结
- **等待时**: 明确告知等待内容和预计时间
- **出错时**: 立即报告+建议下一步

---

## 7. 实施验证清单

### 7.1 每次响应自检
- [ ] 是否正确理解了用户意图？
- [ ] 工具选择是否匹配任务类型？
- [ ] 文件路径是否已验证存在？
- [ ] 输出是否包含可执行的具体步骤？
- [ ] 是否有错误处理方案？
- [ ] 是否保持了对话连贯性？

### 7.2 每日回顾指标
- 意图误解次数：目标<1次/天
- 工具误用次数：目标<1次/天
- 路径错误次数：目标<1次/天
- 用户"不对"/"不是"纠正次数：目标0次

### 7.3 持续改进机制
1. **错误日志**：记录每次工具误用/理解偏差
2. **模式识别**：每周分析高频错误类型
3. **规则更新**：将新发现加入本文档
4. **效果验证**：用户满意度追踪

---

## 8. 快速参考卡

### 意图理解速查
- **含糊→澄清**
- **明确→确认（可选）**
- **延续→追溯上下文**

### 工具选择速查
- **看内容→read**
- **找东西→grep/ast_grep**
- **算东西→bash(bc)**
- **改文件→edit**
- **批量改→ast_grep_replace**
- **不确定→先探索**

### 项目探索速查
- **陌生项目→glob("*")先看结构**
- **找文件→glob→bash(find)**
- **验证路径→bash(test -f)**

### 错误处理速查
- **第一次→分析原因**
- **第二次→尝试替代方案**
- **第三次→咨询Oracle/寻求帮助**

---

*本文档作为AI助手行为改进的基准，每次交互后应参照自检。*
