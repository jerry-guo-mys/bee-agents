<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bee Personal AI Chat</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#374151",
            "primary-hover": "#1F2937",
            "accent-blue": "#E0F2FE",
            "background-light": "#F9FAFB",
            "background-dark": "#111827",
            "surface-light": "#FFFFFF",
            "surface-dark": "#1F2937",
            "border-light": "#E5E7EB",
            "border-dark": "#374151",
            "text-main-light": "#111827",
            "text-main-dark": "#F9FAFB",
            "text-sub-light": "#6B7280",
            "text-sub-dark": "#9CA3AF",
          },
          fontFamily: {
            display: ["Inter", "system-ui", "sans-serif"],
            body: ["Inter", "system-ui", "sans-serif"],
          },
          borderRadius: {
            'xl': '1rem',
            '2xl': '1.5rem',
            '3xl': '2rem',
          },
        },
      },
    };
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <script src="/js/marked.min.js"></script>
  <link rel="stylesheet" href="/css/github-dark.min.css" id="hljs-theme">
  <script src="/js/highlight.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background-color: #D1D5DB; border-radius: 20px; }
    .dark ::-webkit-scrollbar-thumb { background-color: #4B5563; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .typing-dot { animation: bounce 1.4s ease-in-out infinite; }
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes cursor-blink { 50% { opacity: 0; } }
    .streaming-cursor { color: #3b82f6; margin-left: 2px; }
    .dark .streaming-cursor { color: #60a5fa; }
    
    .code-block-wrapper { position: relative; margin: 1em 0; background: #1e293b; border-radius: 8px; overflow: hidden; }
    .code-block-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 14px; background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.08); }
    .code-block-lang { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; font-family: monospace; }
    .code-block-btn { padding: 4px 10px; border: none; border-radius: 4px; background: #334155; color: #94a3b8; font-size: 0.7rem; cursor: pointer; transition: all 0.2s; }
    .code-block-btn:hover { background: #4a5568; color: #fff; }
    .code-block-content { display: flex; overflow-x: auto; }
    .line-numbers { padding: 14px 8px 14px 14px; background: rgba(0,0,0,0.2); color: #64748b; font-size: 0.9em; font-family: monospace; line-height: 1.5; text-align: right; user-select: none; border-right: 1px solid rgba(255,255,255,0.08); }
    .code-with-lines { flex: 1; padding: 14px; overflow-x: auto; }
    
    .dropdown-menu { 
      position: fixed;
      margin-bottom: 8px;
      max-height: 280px;
      overflow-y: auto;
      background: white; 
      border: 1px solid #E5E7EB; 
      border-radius: 12px; 
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      min-width: 200px;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: all 0.2s ease;
    }
    .dark .dropdown-menu { 
      background: #1F2937; 
      border-color: #374151;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    }
    .dropdown-menu.active { opacity: 1; visibility: visible; transform: translateY(0); }
    .dropdown-item { 
      padding: 6px 12px; 
      cursor: pointer; 
      display: flex; 
      align-items: flex-start; 
      gap: 10px;
      transition: background 0.15s;
    }
    .dropdown-item .font-medium { line-height: 1.35; }
    .dropdown-item .text-xs { line-height: 1.35; margin-top: 2px; }
    .dropdown-item:first-child { border-radius: 12px 12px 0 0; }
    .dropdown-item:last-child { border-radius: 0 0 12px 12px; }
    .dropdown-item:hover { background: #F3F4F6; }
    .dark .dropdown-item:hover { background: #374151; }
    .dropdown-item.selected { background: #E0F2FE; color: #0369a1; }
    .dark .dropdown-item.selected { background: rgba(14,165,233,0.2); color: #38bdf8; }
    
    .msg-row.user { min-height: 0; }
    .msg-row.user .message-content { line-height: 1.6; }
    .message-content { line-height: 1.7; user-select: text; -webkit-user-select: text; }
    .message-content p { margin: 0.5em 0; }
    .message-content p:first-child { margin-top: 0; }
    .message-content p:last-child { margin-bottom: 0; }
    .message-content ul, .message-content ol { margin: 0.5em 0; padding-left: 1.5em; }
    .message-content li { margin: 0.25em 0; }
    .message-content code { background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; font-size: 0.9em; font-family: monospace; }
    .dark .message-content code { background: rgba(255,255,255,0.1); }
    .message-content pre { margin: 0.8em 0; }
    .message-content a { color: #3b82f6; text-decoration: none; }
    .message-content a:hover { text-decoration: underline; }
    .message-content blockquote { margin: 0.5em 0; padding-left: 1em; border-left: 3px solid #d1d5db; color: #6b7280; }
    .dark .message-content blockquote { border-color: #4b5563; color: #9ca3af; }
    
    .thinking-bar { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; margin-bottom: 8px; cursor: pointer; user-select: none; flex-shrink: 0; }
    .thinking-bar:hover { opacity: 0.9; }
    .thinking-bar .label { font-size: 0.8rem; color: #6b7280; display: flex; align-items: center; gap: 6px; }
    .dark .thinking-bar .label { color: #9ca3af; }
    .thinking-bar .arrow { font-size: 1rem; color: #9ca3af; transition: transform 0.2s; margin-left: 8px; }
    .thinking-steps .arrow { transition: transform 0.2s; }
    .thinking-bar .duration { font-size: 0.75rem; color: #9ca3af; }
    .thinking-steps { transition: all 0.2s; }
    .thinking-steps.collapsed .steps-content { display: none; }
    .step-item { font-size: 0.8rem; padding: 8px 12px; margin: 6px 0; background: rgba(0,0,0,0.03); border-radius: 8px; border-left: 3px solid #3b82f6; }
    .dark .step-item { background: rgba(255,255,255,0.05); }
    .step-item .step-title { font-weight: 600; color: #374151; margin-bottom: 4px; }
    .dark .step-item .step-title { color: #e5e7eb; }
    .step-item .step-detail { font-size: 0.75rem; opacity: 0.9; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
    .step-item.step-understand { border-color: #6366f1; }
    .step-item.step-decompose { border-color: #8b5cf6; }
    .step-item.step-tool { border-color: #f59e0b; }
    .step-item.step-context { border-color: #06b6d4; }
    .step-item.step-memory { border-color: #10b981; }
    .step-item.step-consolidate { border-color: #14b8a6; }
    .step-item.tool-call { border-color: #f59e0b; }
    .step-item.observation { border-color: #10b981; }
    .step-item.recovery { border-color: #ef4444; }
    
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
    .toast { 
      background: white; 
      border: 1px solid #E5E7EB; 
      border-radius: 10px; 
      padding: 12px 16px; 
      min-width: 280px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      animation: toastEnter 0.3s ease;
    }
    .dark .toast { background: #1F2937; border-color: #374151; }
    @keyframes toastEnter { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    .toast-success { border-left: 3px solid #22c55e; }
    .toast-error { border-left: 3px solid #ef4444; }
    
    .drag-overlay { position: fixed; inset: 0; background: rgba(59, 130, 246, 0.15); backdrop-filter: blur(2px); z-index: 999; display: none; align-items: center; justify-content: center; }
    .drag-overlay.active { display: flex; }
    
    /* Settings Modal */
    .settings-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1001; display: none; align-items: center; justify-content: center; }
    .settings-modal.active { display: flex; }
    .settings-panel { background: white; border-radius: 16px; width: 90%; max-width: 480px; max-height: 85vh; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.25); animation: modalEnter 0.2s ease-out; }
    .dark .settings-panel { background: #1F2937; }
    @keyframes modalEnter { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .settings-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #E5E7EB; }
    .dark .settings-header { border-color: #374151; }
    .settings-body { padding: 16px 24px; overflow-y: auto; max-height: calc(85vh - 130px); }
    .settings-footer { padding: 16px 24px; border-top: 1px solid #E5E7EB; text-align: center; }
    .dark .settings-footer { border-color: #374151; }
    .settings-section { margin-bottom: 24px; }
    .settings-section:last-child { margin-bottom: 0; }
    .settings-section-title { font-size: 0.75rem; font-weight: 600; color: #6B7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; }
    .dark .settings-section-title { color: #9CA3AF; }
    .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #F3F4F6; }
    .settings-item:last-child { border-bottom: none; }
    .dark .settings-item { border-color: #374151; }
    .settings-item-label { font-size: 0.9rem; color: #374151; }
    .dark .settings-item-label { color: #E5E7EB; }
    .settings-item-desc { font-size: 0.75rem; color: #9CA3AF; margin-top: 2px; }
    .settings-toggle { position: relative; width: 44px; height: 24px; background: #D1D5DB; border-radius: 12px; cursor: pointer; transition: background 0.2s; }
    .settings-toggle.active { background: #3B82F6; }
    .settings-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
    .settings-toggle.active::after { transform: translateX(20px); }
    .settings-select { padding: 8px 12px; border: 1px solid #E5E7EB; border-radius: 8px; background: white; font-size: 0.85rem; color: #374151; cursor: pointer; min-width: 140px; }
    .dark .settings-select { background: #374151; border-color: #4B5563; color: #E5E7EB; }
    .settings-btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .settings-btn-primary { background: #3B82F6; color: white; }
    .settings-btn-primary:hover { background: #2563EB; }
    .settings-btn-danger { background: #FEE2E2; color: #DC2626; }
    .settings-btn-danger:hover { background: #FECACA; }
    .dark .settings-btn-danger { background: rgba(220,38,38,0.2); }
    .settings-slider { width: 120px; height: 6px; -webkit-appearance: none; background: #E5E7EB; border-radius: 3px; outline: none; }
    .dark .settings-slider { background: #4B5563; }
    .settings-slider::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: #3B82F6; border-radius: 50%; cursor: pointer; }
    .settings-models-list { max-height: 200px; overflow-y: auto; border: 1px solid #E5E7EB; border-radius: 8px; padding: 8px; }
    .dark .settings-models-list { border-color: #374151; }
    .settings-model-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-radius: 6px; cursor: pointer; transition: background 0.15s; }
    .settings-model-item:hover { background: #F3F4F6; }
    .dark .settings-model-item:hover { background: #374151; }
    .settings-model-checkbox { width: 18px; height: 18px; border: 2px solid #D1D5DB; border-radius: 4px; display: flex; align-items: center; justify-content: center; transition: all 0.15s; flex-shrink: 0; }
    .dark .settings-model-checkbox { border-color: #4B5563; }
    .settings-model-checkbox.checked { background: #3B82F6; border-color: #3B82F6; }
    .settings-model-checkbox.checked::after { content: '✓'; color: white; font-size: 12px; font-weight: bold; }
    .settings-model-name { font-size: 0.85rem; color: #374151; }
    .dark .settings-model-name { color: #E5E7EB; }
    
    /* Skills list */
    .settings-skills-list { max-height: 200px; overflow-y: auto; border: 1px solid #E5E7EB; border-radius: 8px; }
    .dark .settings-skills-list { border-color: #374151; }
    .settings-skill-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid #F3F4F6; cursor: pointer; transition: background 0.15s; }
    .settings-skill-item:last-child { border-bottom: none; }
    .settings-skill-item:hover { background: #F3F4F6; }
    .dark .settings-skill-item { border-color: #374151; }
    .dark .settings-skill-item:hover { background: #374151; }
    .settings-skill-info { flex: 1; min-width: 0; }
    .settings-skill-name { font-size: 0.85rem; font-weight: 500; color: #374151; }
    .dark .settings-skill-name { color: #E5E7EB; }
    .settings-skill-desc { font-size: 0.75rem; color: #9CA3AF; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .settings-skill-tags { display: flex; gap: 4px; margin-top: 4px; }
    .settings-skill-tag { font-size: 0.65rem; padding: 2px 6px; background: #E5E7EB; color: #6B7280; border-radius: 4px; }
    .dark .settings-skill-tag { background: #374151; color: #9CA3AF; }
    .settings-skill-edit-btn { padding: 4px 8px; font-size: 0.75rem; background: #3B82F6; color: white; border: none; border-radius: 4px; cursor: pointer; }
    .settings-skill-edit-btn:hover { background: #2563EB; }
    
    /* Skill edit modal */
    .skill-edit-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1002; display: none; align-items: center; justify-content: center; }
    .skill-edit-modal.active { display: flex; }
    .skill-edit-panel { background: white; border-radius: 16px; width: 90%; max-width: 600px; max-height: 85vh; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.25); animation: modalEnter 0.2s ease-out; }
    .dark .skill-edit-panel { background: #1F2937; }
    .skill-edit-header { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #E5E7EB; }
    .dark .skill-edit-header { border-color: #374151; }
    .skill-edit-body { padding: 20px; overflow-y: auto; max-height: calc(85vh - 140px); }
    .skill-edit-footer { padding: 16px 20px; border-top: 1px solid #E5E7EB; display: flex; justify-content: flex-end; gap: 12px; }
    .dark .skill-edit-footer { border-color: #374151; }
    .skill-edit-field { margin-bottom: 16px; }
    .skill-edit-label { display: block; font-size: 0.85rem; font-weight: 500; color: #374151; margin-bottom: 6px; }
    .dark .skill-edit-label { color: #E5E7EB; }
    .skill-edit-input { width: 100%; padding: 10px 12px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 0.9rem; background: white; color: #374151; }
    .dark .skill-edit-input { background: #374151; border-color: #4B5563; color: #E5E7EB; }
    .skill-edit-textarea { width: 100%; min-height: 120px; padding: 10px 12px; border: 1px solid #E5E7EB; border-radius: 8px; font-size: 0.85rem; font-family: monospace; background: white; color: #374151; resize: vertical; }
    .dark .skill-edit-textarea { background: #374151; border-color: #4B5563; color: #E5E7EB; }
    
    /* Settings View (in main area) */
    .settings-view-section { margin-bottom: 32px; }
    .settings-view-title { font-size: 0.8rem; font-weight: 600; color: #6B7280; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; }
    .dark .settings-view-title { color: #9CA3AF; }
    .settings-view-card { background: white; border: 1px solid #E5E7EB; border-radius: 12px; overflow: hidden; }
    .dark .settings-view-card { background: #1F2937; border-color: #374151; }
    .settings-view-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #F3F4F6; }
    .settings-view-item:last-child { border-bottom: none; }
    .dark .settings-view-item { border-color: #374151; }
    .settings-view-item-info { display: flex; align-items: center; flex: 1; min-width: 0; }
    .settings-view-item-label { font-size: 0.95rem; font-weight: 500; color: #374151; }
    .dark .settings-view-item-label { color: #E5E7EB; }
    .settings-view-item-desc { font-size: 0.8rem; color: #9CA3AF; margin-top: 2px; }
    .settings-view-skills-list { }
    .settings-view-skill-item { display: flex; align-items: center; justify-content: space-between; padding: 14px 20px; border-bottom: 1px solid #F3F4F6; cursor: pointer; transition: background 0.15s; }
    .settings-view-skill-item:last-child { border-bottom: none; }
    .settings-view-skill-item:hover { background: #F9FAFB; }
    .dark .settings-view-skill-item { border-color: #374151; }
    .dark .settings-view-skill-item:hover { background: #374151; }
    .settings-view-skill-info { flex: 1; min-width: 0; }
    .settings-view-skill-name { font-size: 0.9rem; font-weight: 500; color: #374151; }
    .dark .settings-view-skill-name { color: #E5E7EB; }
    .settings-view-skill-desc { font-size: 0.8rem; color: #9CA3AF; margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .settings-view-skill-tags { display: flex; gap: 4px; margin-top: 6px; flex-wrap: wrap; }
    .settings-view-skill-tag { font-size: 0.7rem; padding: 2px 8px; background: #E5E7EB; color: #6B7280; border-radius: 4px; }
    .dark .settings-view-skill-tag { background: #374151; color: #9CA3AF; }
    .settings-view-skill-edit-btn { padding: 6px 12px; font-size: 0.8rem; background: #3B82F6; color: white; border: none; border-radius: 6px; cursor: pointer; transition: background 0.2s; }
    .settings-view-skill-edit-btn:hover { background: #2563EB; }
    
    .scroll-bottom { 
      position: fixed; 
      bottom: 120px; 
      right: 24px; 
      width: 44px; 
      height: 44px; 
      border: none; 
      border-radius: 50%; 
      background: #374151; 
      color: white; 
      cursor: pointer;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s;
      box-shadow: 0 4px 14px rgba(0,0,0,0.2);
    }
    .dark .scroll-bottom { background: #4b5563; }
    .scroll-bottom.visible { opacity: 1; transform: translateY(0); }
    .scroll-bottom:hover { background: #1f2937; transform: translateY(-2px); }
    
    /* Sidebar collapse - desktop */
    aside { transition: width 0.3s; }
    aside .sidebar-content { display: flex; flex-direction: column; flex: 1; min-width: 0; overflow: hidden; }
    aside .sidebar-icon-bar { display: none; flex-direction: column; align-items: center; padding: 16px 0; gap: 8px; }
    aside .sidebar-icon-bar button { width: 40px; height: 40px; border: none; border-radius: 10px; background: transparent; color: #6b7280; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; }
    aside .sidebar-icon-bar button:hover { background: rgba(0,0,0,0.08); }
    .dark aside .sidebar-icon-bar button:hover { background: rgba(255,255,255,0.08); }
    @media (min-width: 769px) {
      aside.collapsed { width: 64px !important; min-width: 64px; }
      aside.collapsed .sidebar-content { display: none; }
      aside.collapsed .sidebar-icon-bar { display: flex; }
    }
    
    /* Mobile sidebar */
    @media (max-width: 768px) {
      aside { position: fixed; width: 320px !important; transform: translateX(-100%); transition: transform 0.3s; z-index: 100; }
      aside.mobile-open { transform: translateX(0); }
      aside .sidebar-icon-bar { display: none !important; }
      aside.collapsed .sidebar-content { display: flex !important; }
      main { margin-left: 0; }
    }
    
    /* Button hover states */
    button { cursor: pointer; }
    button:disabled { cursor: not-allowed; }
    
    /* Session item active state */
    .session-item.active { background: white; }
    .dark .session-item.active { background: #1f2937; }
    .session-item.active a { border-left: 3px solid #3b82f6; }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-main-light dark:text-text-main-dark h-screen flex overflow-hidden">
  <aside id="sidebar" class="w-80 bg-[#F3F4F6] dark:bg-[#1a2233] flex flex-col border-r border-border-light dark:border-border-dark flex-shrink-0 h-full">
    <div class="sidebar-icon-bar">
      <button type="button" id="sidebar-expand-btn" title="展开侧边栏"><span class="material-icons-outlined">menu</span></button>
      <button type="button" id="sidebar-new-chat-icon" title="新对话"><span class="material-icons-outlined">edit_note</span></button>
      <div class="flex-1"></div>
      <button type="button" id="sidebar-settings-icon" title="设置"><span class="material-icons-outlined">settings</span></button>
    </div>
    <div class="sidebar-content">
    <div class="h-16 flex items-center justify-between px-4 mt-2">
      <div class="flex items-center gap-3">
        <button id="sidebar-toggle" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-text-sub-light dark:text-text-sub-dark">
          <span class="material-icons-outlined text-xl">menu</span>
        </button>
        <h1 class="font-bold text-xl tracking-tight text-text-main-light dark:text-text-main-dark flex items-center gap-1">
          Bee <span class="font-semibold text-gray-500 dark:text-gray-400">Chat</span>
        </h1>
      </div>
      <button id="sidebar-search-btn" class="p-2 rounded-lg bg-white dark:bg-gray-800 shadow-sm border border-border-light dark:border-border-dark hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
        <span class="material-icons-outlined text-gray-500 dark:text-gray-400 text-lg">search</span>
      </button>
    </div>
    
    <div id="sidebar-search-box" class="hidden px-4 pb-2">
      <div class="relative">
        <input type="text" id="session-search-input" placeholder="搜索会话..." 
          class="w-full px-4 py-2 pl-10 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        <span class="material-icons-outlined absolute left-3 top-2 text-gray-400 text-sm">search</span>
        <button id="search-clear" class="hidden absolute right-2 top-1.5 p-1 text-gray-400 hover:text-gray-600">
          <span class="material-icons-outlined text-sm">close</span>
        </button>
      </div>
      <div id="search-stats" class="hidden text-xs text-gray-400 mt-2 px-1"></div>
    </div>
    
    <div class="px-4 py-4 flex gap-2">
      <button id="new-chat-btn" class="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-white dark:bg-gray-800 border border-transparent dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 rounded-xl shadow-sm hover:shadow text-text-main-light dark:text-text-main-dark transition-all duration-200 group">
        <span class="material-icons-outlined text-blue-500 group-hover:scale-110 transition-transform">edit_note</span>
        <span class="font-medium">New Chat</span>
      </button>
      <button id="new-group-btn" class="flex items-center justify-center gap-2 px-4 py-3 bg-white dark:bg-gray-800 border border-transparent dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 rounded-xl shadow-sm hover:shadow text-text-main-light dark:text-text-main-dark transition-all duration-200 group" title="创建群聊">
        <span class="material-icons-outlined text-green-500 group-hover:scale-110 transition-transform">group_add</span>
      </button>
    </div>
    
    <div id="groups-section" class="px-2 pb-2 hidden">
      <h3 class="px-4 text-xs font-semibold text-text-sub-light dark:text-text-sub-dark uppercase tracking-wider mb-2">群聊</h3>
      <ul id="group-list" class="space-y-1"></ul>
    </div>
    <div id="session-list" class="flex-1 overflow-y-auto px-2 pb-4 space-y-6 no-scrollbar">
      <div id="empty-sessions" class="hidden px-4 py-8 text-center text-gray-400">
        <span class="material-icons-outlined text-4xl mb-2">chat_bubble_outline</span>
        <p class="text-sm">还没有会话</p>
        <p class="text-xs mt-1 opacity-70">点击上方按钮开始新对话</p>
      </div>
    </div>
    
    <!-- Sidebar Settings -->
    <div class="px-4 py-3 border-t border-gray-200 dark:border-gray-700">
      <button id="sidebar-settings-btn" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-white dark:hover:bg-gray-800 text-text-sub-light dark:text-text-sub-dark transition-all group">
        <span class="material-icons-outlined text-gray-500 group-hover:text-blue-500 transition-colors">settings</span>
        <span class="font-medium">设置</span>
      </button>
    </div>
    </div>
  </aside>

  <main class="flex-1 flex flex-col h-full bg-surface-light dark:bg-background-dark relative">
    <header class="h-16 flex items-center justify-between px-8 border-b border-transparent dark:border-border-dark flex-shrink-0">
      <div class="flex items-center gap-3">
        <button id="header-sidebar-toggle" class="md:hidden p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" title="打开侧边栏"><span class="material-icons-outlined">menu</span></button>
        <h2 id="current-session-title" class="text-lg text-text-sub-light dark:text-text-sub-dark font-normal truncate max-w-md">New Chat</h2>
      </div>
      <div class="flex items-center gap-4 text-sm text-text-sub-light dark:text-text-sub-dark">
        <div class="hidden sm:flex gap-4">
          <span id="token-stats-session">This Session: 0</span>
          <span id="token-stats-total">Total: 0</span>
        </div>
        <div class="flex gap-2">
          <button id="import-btn" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-xs font-medium">
            <span class="material-icons-outlined text-sm text-blue-500">file_upload</span>
            Import
          </button>
          <button id="export-btn" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-xs font-medium">
            <span class="material-icons-outlined text-sm text-blue-500">file_download</span>
            Export
          </button>
          <button id="inbox-process-btn" class="hidden items-center gap-1.5 px-3 py-1.5 rounded-lg bg-green-100 dark:bg-green-900/30 hover:bg-green-200 dark:hover:bg-green-800/40 transition-colors text-xs font-medium text-green-800 dark:text-green-200" title="处理收件箱：让助手回复未读消息">
            <span class="material-icons-outlined text-sm">inbox</span>
            Process Inbox
          </button>
        </div>
      </div>
    </header>

    <div id="messages-wrapper" class="flex-1 overflow-y-auto flex flex-col items-center pb-40 px-4">
      <div id="welcome-screen" class="text-center max-w-2xl w-full animate-fade-in-up flex flex-col items-center justify-center h-full">
        <h1 class="text-4xl md:text-5xl font-bold text-text-main-light dark:text-white mb-4 tracking-tight">
          Bee <span class="font-normal text-text-main-light dark:text-gray-200">Personal AI Agent</span>
        </h1>
        <p class="text-text-sub-light dark:text-text-sub-dark text-lg mb-10 font-light">
          Select an agent and model below to start a new conversation.
        </p>
        <div class="flex flex-wrap justify-center gap-4 mb-12">
          <button id="welcome-new-chat" class="bg-primary hover:bg-primary-hover text-white px-8 py-3 rounded-lg font-medium shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5 flex items-center gap-2">
            <span>New Conversation</span>
          </button>
        </div>
        <div class="flex flex-wrap justify-center gap-3">
          <button class="suggestion-btn px-6 py-2.5 rounded-full bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark hover:border-blue-400 dark:hover:border-blue-500 hover:text-blue-600 dark:hover:text-blue-400 text-text-sub-light dark:text-text-sub-dark transition-colors shadow-sm text-sm">View Files</button>
          <button class="suggestion-btn px-6 py-2.5 rounded-full bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark hover:border-blue-400 dark:hover:border-blue-500 hover:text-blue-600 dark:hover:text-blue-400 text-text-sub-light dark:text-text-sub-dark transition-colors shadow-sm text-sm">Check Weather</button>
          <button class="suggestion-btn px-6 py-2.5 rounded-full bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark hover:border-blue-400 dark:hover:border-blue-500 hover:text-blue-600 dark:hover:text-blue-400 text-text-sub-light dark:text-text-sub-dark transition-colors shadow-sm text-sm">Search Knowledge</button>
          <button class="suggestion-btn px-6 py-2.5 rounded-full bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark hover:border-blue-400 dark:hover:border-blue-500 hover:text-blue-600 dark:hover:text-blue-400 text-text-sub-light dark:text-text-sub-dark transition-colors shadow-sm text-sm">Write Code</button>
        </div>
      </div>
      
      <div id="messages" class="hidden w-full max-w-3xl py-8 space-y-6"></div>
    </div>
    
    <!-- Settings View (in main area) -->
    <div id="settings-view" class="hidden flex-1 overflow-y-auto">
      <div class="max-w-2xl mx-auto py-8 px-6">
        <div class="flex items-center justify-between mb-8">
          <h2 class="text-2xl font-bold text-text-main-light dark:text-text-main-dark">设置</h2>
          <button id="settings-view-close" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 text-gray-500 hover:text-gray-700 dark:hover:text-gray-200 transition-colors">
            <span class="material-icons-outlined">close</span>
          </button>
        </div>
        
        <!-- Appearance -->
        <div class="settings-view-section">
          <h3 class="settings-view-title">外观</h3>
          <div class="settings-view-card">
            <div class="settings-view-item">
              <div class="settings-view-item-info">
                <span class="material-icons-outlined text-gray-400 mr-3">palette</span>
                <div>
                  <div class="settings-view-item-label">主题</div>
                  <div class="settings-view-item-desc">选择界面颜色主题</div>
                </div>
              </div>
              <select id="settings-view-theme" class="settings-select">
                <option value="system">跟随系统</option>
                <option value="light">浅色</option>
                <option value="dark">深色</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Chat -->
        <div class="settings-view-section">
          <h3 class="settings-view-title">对话</h3>
          <div class="settings-view-card">
            <div class="settings-view-item">
              <div class="settings-view-item-info">
                <span class="material-icons-outlined text-gray-400 mr-3">text_fields</span>
                <div>
                  <div class="settings-view-item-label">打字机效果</div>
                  <div class="settings-view-item-desc">消息逐字显示动画</div>
                </div>
              </div>
              <div id="settings-view-typewriter-toggle" class="settings-toggle active"></div>
            </div>
            <div class="settings-view-item" id="settings-view-speed-row">
              <div class="settings-view-item-info">
                <span class="material-icons-outlined text-gray-400 mr-3">speed</span>
                <div>
                  <div class="settings-view-item-label">打字速度</div>
                  <div class="settings-view-item-desc">调整动画速度</div>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-xs text-gray-400">慢</span>
                <input type="range" id="settings-view-typewriter-speed" class="settings-slider" min="0.2" max="2" step="0.1" value="1">
                <span class="text-xs text-gray-400">快</span>
              </div>
            </div>
            <div class="settings-view-item">
              <div class="settings-view-item-info">
                <span class="material-icons-outlined text-gray-400 mr-3">vertical_align_bottom</span>
                <div>
                  <div class="settings-view-item-label">自动滚动</div>
                  <div class="settings-view-item-desc">新消息时自动滚动到底部</div>
                </div>
              </div>
              <div id="settings-view-autoscroll-toggle" class="settings-toggle active"></div>
            </div>
          </div>
        </div>
        
        <!-- Defaults -->
        <div class="settings-view-section">
          <h3 class="settings-view-title">默认设置</h3>
          <div class="settings-view-card">
            <div class="settings-view-item">
              <div class="settings-view-item-info">
                <span class="material-icons-outlined text-gray-400 mr-3">psychology</span>
                <div>
                  <div class="settings-view-item-label">默认助手</div>
                  <div class="settings-view-item-desc">新对话使用的助手</div>
                </div>
              </div>
              <select id="settings-view-default-assistant" class="settings-select">
                <option value="auto">自动</option>
              </select>
            </div>
            <div class="settings-view-item">
              <div class="settings-view-item-info">
                <span class="material-icons-outlined text-gray-400 mr-3">auto_awesome</span>
                <div>
                  <div class="settings-view-item-label">默认模型</div>
                  <div class="settings-view-item-desc">新对话使用的模型</div>
                </div>
              </div>
              <select id="settings-view-default-model" class="settings-select">
                <option value="default">默认</option>
              </select>
            </div>
          </div>
        </div>
        
        <!-- Skills Management -->
        <div class="settings-view-section">
          <h3 class="settings-view-title">技能管理</h3>
          <div class="settings-view-card">
            <div id="settings-view-skills-list" class="settings-view-skills-list">
              <!-- Dynamic skills list -->
            </div>
          </div>
          <div class="flex gap-2 mt-3">
            <button id="settings-view-skills-refresh" class="px-4 py-2 text-sm bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">刷新技能</button>
            <button id="settings-view-skills-import-openclaw" class="px-4 py-2 text-sm bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">导入 OpenClaw 技能</button>
          </div>
        </div>
        
        <!-- Available Models -->
        <div class="settings-view-section">
          <h3 class="settings-view-title">可用模型</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400 mb-3">选择在模型列表中显示的模型</p>
          <div class="settings-view-card">
            <div id="settings-view-models-list" class="p-2">
              <!-- Dynamic model checkboxes -->
            </div>
          </div>
          <div class="flex gap-2 mt-3">
            <button id="settings-view-models-all" class="px-4 py-2 text-sm bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">全选</button>
            <button id="settings-view-models-none" class="px-4 py-2 text-sm bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">全不选</button>
          </div>
        </div>
        
        <!-- Data Management -->
        <div class="settings-view-section">
          <h3 class="settings-view-title">数据管理</h3>
          <div class="settings-view-card">
            <div class="settings-view-item">
              <div class="settings-view-item-info">
                <span class="material-icons-outlined text-gray-400 mr-3">delete_outline</span>
                <div>
                  <div class="settings-view-item-label">清除当前对话</div>
                  <div class="settings-view-item-desc">删除当前会话的所有消息</div>
                </div>
              </div>
              <button id="settings-view-clear-current" class="settings-btn settings-btn-danger">清除</button>
            </div>
            <div class="settings-view-item">
              <div class="settings-view-item-info">
                <span class="material-icons-outlined text-gray-400 mr-3">delete_sweep</span>
                <div>
                  <div class="settings-view-item-label">清除所有对话</div>
                  <div class="settings-view-item-desc">删除所有会话记录</div>
                </div>
              </div>
              <button id="settings-view-clear-all" class="settings-btn settings-btn-danger">全部清除</button>
            </div>
          </div>
        </div>
        
        <div class="text-center text-sm text-gray-400 dark:text-gray-500 mt-8 pb-8">
          <a href="/swarm" target="_blank" class="text-blue-500 hover:underline mr-4">蜂群拓扑</a>
          <a href="/tasks" target="_blank" class="text-blue-500 hover:underline">任务看板</a>
          Bee Personal AI v0.1.0
        </div>
      </div>
    </div>

    <div id="input-area" class="absolute bottom-0 left-0 right-0 px-6 pb-4 pt-8 bg-gradient-to-t from-surface-light via-surface-light to-transparent dark:from-background-dark dark:via-background-dark">
      <div class="max-w-4xl mx-auto w-full">
        <div class="bg-white dark:bg-[#1a2233] rounded-2xl border border-gray-200 dark:border-gray-700 shadow-lg dark:shadow-xl overflow-visible focus-within:ring-2 focus-within:ring-blue-100 dark:focus-within:ring-blue-900/30 transition-shadow">
          <div class="px-4 pt-2 pb-0">
            <textarea id="message-input" 
              class="w-full resize-none border-0 bg-transparent py-1.5 px-2 text-text-main-light dark:text-text-main-dark placeholder-gray-400 dark:placeholder-gray-500 focus:ring-0 text-base max-h-36 overflow-y-auto min-h-[1.5rem]"
              placeholder="Type a message here, press ↵ to send" 
              rows="1"></textarea>
          </div>
          
          <div class="px-3 py-2 flex items-center justify-between bg-transparent overflow-visible">
            <div class="flex items-center gap-2 overflow-x-auto no-scrollbar overflow-y-visible">
              <div class="relative">
                <button id="assistant-selector" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 text-xs font-medium text-text-sub-light dark:text-text-sub-dark transition-colors whitespace-nowrap">
                  <span id="selected-assistant">Auto Helper</span>
                  <span class="material-icons-outlined text-sm">expand_more</span>
                </button>
                <div id="assistant-dropdown" class="dropdown-menu"></div>
              </div>
              
              <div class="relative">
                <button id="model-selector" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 text-xs font-medium text-text-sub-light dark:text-text-sub-dark transition-colors whitespace-nowrap">
                  <span class="material-icons-outlined text-xs text-yellow-500">auto_awesome</span>
                  <span id="selected-model">Default (Config)</span>
                  <span class="material-icons-outlined text-sm">expand_more</span>
                </button>
                <div id="model-dropdown" class="dropdown-menu"></div>
              </div>
              
              <span class="text-xs text-gray-400 ml-2 hidden sm:inline-block">Shift+Enter for new line</span>
            </div>
            
            <div class="flex items-center gap-3 flex-shrink-0">
              <button id="mode-btn" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="Toggle theme">
                <span class="material-icons-outlined" id="mode-btn-icon">dark_mode</span>
              </button>
              <button id="config-btn" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="Config">
                <span class="material-icons-outlined">settings</span>
              </button>
              <button id="attach-btn" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="Attach file">
                <span class="material-icons-outlined rotate-45">attach_file</span>
              </button>
              <button id="expand-btn" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 hidden sm:block" title="Expand">
                <span class="material-icons-outlined">fullscreen</span>
              </button>
              <button id="send-btn" class="h-10 w-10 flex items-center justify-center rounded-xl bg-primary hover:bg-primary-hover text-white shadow-md hover:shadow-lg transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed ml-2">
                <span class="material-icons-outlined text-xl">arrow_upward</span>
              </button>
            </div>
          </div>
        </div>
        <p class="text-center text-xs text-gray-400 mt-2 dark:text-gray-600">AI can make mistakes. Consider checking important information.</p>
      </div>
    </div>
    
    <button id="scroll-bottom" class="scroll-bottom">
      <span class="material-icons-outlined">keyboard_arrow_down</span>
    </button>
  </main>

  <div id="toast-container" class="toast-container"></div>
  
  <!-- New Group Modal -->
  <div id="new-group-modal" class="settings-modal">
    <div class="settings-panel" style="max-width: 400px;">
      <div class="settings-header">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100">创建群聊</h2>
        <button id="new-group-close" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
          <span class="material-icons-outlined">close</span>
        </button>
      </div>
      <div class="settings-body">
        <div class="settings-section">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">群名称（可选）</label>
          <input type="text" id="new-group-name" placeholder="群聊" class="w-full px-4 py-2 rounded-lg border border-gray-200 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100">
        </div>
        <div class="settings-section">
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">选择助手成员</label>
          <div id="new-group-members" class="space-y-2 max-h-48 overflow-y-auto"></div>
        </div>
        <button id="new-group-create" class="w-full py-2 rounded-lg bg-primary hover:bg-primary-hover text-white font-medium">创建</button>
      </div>
    </div>
  </div>
  
  <!-- Settings Modal -->
  <div id="settings-modal" class="settings-modal">
    <div class="settings-panel">
      <div class="settings-header">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100">设置</h2>
        <button id="settings-close" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
          <span class="material-icons-outlined">close</span>
        </button>
      </div>
      <div class="settings-body">
        <!-- Appearance -->
        <div class="settings-section">
          <div class="settings-section-title">外观</div>
          <div class="settings-item">
            <div>
              <div class="settings-item-label">主题</div>
              <div class="settings-item-desc">选择界面颜色主题</div>
            </div>
            <select id="settings-theme" class="settings-select">
              <option value="system">跟随系统</option>
              <option value="light">浅色</option>
              <option value="dark">深色</option>
            </select>
          </div>
        </div>
        
        <!-- Chat -->
        <div class="settings-section">
          <div class="settings-section-title">对话</div>
          <div class="settings-item">
            <div>
              <div class="settings-item-label">打字机效果</div>
              <div class="settings-item-desc">消息逐字显示动画</div>
            </div>
            <div id="settings-typewriter-toggle" class="settings-toggle active"></div>
          </div>
          <div class="settings-item" id="typewriter-speed-row">
            <div>
              <div class="settings-item-label">打字速度</div>
              <div class="settings-item-desc">调整动画速度</div>
            </div>
            <div class="flex items-center gap-2">
              <span class="text-xs text-gray-400">慢</span>
              <input type="range" id="settings-typewriter-speed" class="settings-slider" min="0.2" max="2" step="0.1" value="1">
              <span class="text-xs text-gray-400">快</span>
            </div>
          </div>
          <div class="settings-item">
            <div>
              <div class="settings-item-label">自动滚动</div>
              <div class="settings-item-desc">新消息时自动滚动到底部</div>
            </div>
            <div id="settings-autoscroll-toggle" class="settings-toggle active"></div>
          </div>
        </div>
        
        <!-- Default -->
        <div class="settings-section">
          <div class="settings-section-title">默认设置</div>
          <div class="settings-item">
            <div>
              <div class="settings-item-label">默认助手</div>
              <div class="settings-item-desc">新对话使用的助手</div>
            </div>
            <select id="settings-default-assistant" class="settings-select">
              <option value="auto">自动</option>
            </select>
          </div>
          <div class="settings-item">
            <div>
              <div class="settings-item-label">默认模型</div>
              <div class="settings-item-desc">新对话使用的模型</div>
            </div>
            <select id="settings-default-model" class="settings-select">
              <option value="default">默认</option>
            </select>
          </div>
        </div>
        
        <!-- Skills Management -->
        <div class="settings-section">
          <div class="settings-section-title">技能管理</div>
          <div class="settings-item-desc" style="margin-bottom: 12px;">查看和编辑可用技能</div>
          <div id="settings-skills-list" class="settings-skills-list">
            <!-- Dynamic skills list -->
          </div>
          <div class="flex gap-2 mt-3">
            <button id="settings-skills-refresh" class="settings-btn text-xs px-3 py-1.5" style="background: #E5E7EB; color: #374151;">刷新技能</button>
            <button id="settings-skills-import-openclaw" class="settings-btn text-xs px-3 py-1.5" style="background: #3B82F6; color: white;">导入 OpenClaw 技能</button>
          </div>
        </div>
        
        <!-- Model Selection -->
        <div class="settings-section">
          <div class="settings-section-title">可用模型</div>
          <div class="settings-item-desc" style="margin-bottom: 12px;">选择在模型列表中显示的模型</div>
          <div id="settings-models-list" class="settings-models-list">
            <!-- Dynamic model checkboxes -->
          </div>
          <div class="flex gap-2 mt-3">
            <button id="settings-models-all" class="settings-btn text-xs px-3 py-1.5" style="background: #E5E7EB; color: #374151;">全选</button>
            <button id="settings-models-none" class="settings-btn text-xs px-3 py-1.5" style="background: #E5E7EB; color: #374151;">全不选</button>
          </div>
        </div>
        
        <!-- Data -->
        <div class="settings-section">
          <div class="settings-section-title">数据管理</div>
          <div class="settings-item">
            <div>
              <div class="settings-item-label">清除当前对话</div>
              <div class="settings-item-desc">删除当前会话的所有消息</div>
            </div>
            <button id="settings-clear-current" class="settings-btn settings-btn-danger">清除</button>
          </div>
          <div class="settings-item">
            <div>
              <div class="settings-item-label">清除所有对话</div>
              <div class="settings-item-desc">删除所有会话记录</div>
            </div>
            <button id="settings-clear-all" class="settings-btn settings-btn-danger">全部清除</button>
          </div>
        </div>
        
        <!-- Monitoring -->
        <div class="settings-section">
          <div class="settings-section-title">监控与分析</div>
          <div class="settings-item">
            <div>
              <div class="settings-item-label">Metrics Dashboard</div>
              <div class="settings-item-desc">查看系统运行指标和 AI 行为质量</div>
            </div>
            <a href="/metrics" target="_blank" class="settings-btn" style="background: #10B981; color: white; text-decoration: none;">
              <span class="material-icons-outlined text-sm mr-1">analytics</span>
              打开
            </a>
          </div>
        </div>
      </div>
      <div class="settings-footer">
        <p class="text-xs text-gray-400 dark:text-gray-500">Bee Personal AI v0.1.0</p>
      </div>
    </div>
  </div>
  
  <!-- Skill Edit Modal -->
  <div id="skill-edit-modal" class="skill-edit-modal">
    <div class="skill-edit-panel">
      <div class="skill-edit-header">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100">编辑技能</h2>
        <button id="skill-edit-close" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
          <span class="material-icons-outlined">close</span>
        </button>
      </div>
      <div class="skill-edit-body">
        <input type="hidden" id="skill-edit-id">
        <div class="skill-edit-field">
          <label class="skill-edit-label">技能名称</label>
          <input type="text" id="skill-edit-name" class="skill-edit-input" placeholder="技能名称">
        </div>
        <div class="skill-edit-field">
          <label class="skill-edit-label">描述</label>
          <input type="text" id="skill-edit-description" class="skill-edit-input" placeholder="简短描述">
        </div>
        <div class="skill-edit-field">
          <label class="skill-edit-label">标签（逗号分隔）</label>
          <input type="text" id="skill-edit-tags" class="skill-edit-input" placeholder="写作, 营销, 自媒体">
        </div>
        <div class="skill-edit-field">
          <label class="skill-edit-label">能力描述（Markdown）</label>
          <textarea id="skill-edit-capability" class="skill-edit-textarea" placeholder="# 能力描述&#10;&#10;- 能力1&#10;- 能力2"></textarea>
        </div>
        <div class="skill-edit-field">
          <label class="skill-edit-label">模板（可选，Markdown）</label>
          <textarea id="skill-edit-template" class="skill-edit-textarea" placeholder="# 模板&#10;&#10;模板内容..."></textarea>
        </div>
      </div>
      <div class="skill-edit-footer">
        <button id="skill-edit-cancel" class="settings-btn" style="background: #E5E7EB; color: #374151;">取消</button>
        <button id="skill-edit-save" class="settings-btn settings-btn-primary">保存</button>
      </div>
    </div>
  </div>
  
  <!-- OpenClaw Import Modal -->
  <div id="openclaw-import-modal" class="skill-edit-modal">
    <div class="skill-edit-panel">
      <div class="skill-edit-header">
        <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-100">导入 OpenClaw 技能</h2>
        <button id="openclaw-import-close" class="p-1 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors">
          <span class="material-icons-outlined">close</span>
        </button>
      </div>
      <div class="skill-edit-body">
        <div class="skill-edit-field">
          <label class="skill-edit-label">skill.json 内容</label>
          <textarea id="openclaw-skill-json" class="skill-edit-textarea" rows="6" placeholder='{"name": "my-skill", "description": "描述", "tags": ["tag1"]}'></textarea>
        </div>
        <div class="skill-edit-field">
          <label class="skill-edit-label">SKILL.md 内容（可选）</label>
          <textarea id="openclaw-skill-md" class="skill-edit-textarea" rows="6" placeholder="# 技能详细说明&#10;&#10;描述技能的功能和用法..."></textarea>
        </div>
        <div class="skill-edit-field">
          <label class="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-300">
            <input type="checkbox" id="openclaw-overwrite" class="rounded">
            覆盖已存在的同名技能
          </label>
        </div>
      </div>
      <div class="skill-edit-footer">
        <button id="openclaw-import-cancel" class="settings-btn" style="background: #E5E7EB; color: #374151;">取消</button>
        <button id="openclaw-import-save" class="settings-btn settings-btn-primary">导入</button>
      </div>
    </div>
  </div>
  
  <div id="drag-overlay" class="drag-overlay">
    <div class="bg-white dark:bg-gray-800 border-2 border-dashed border-blue-500 rounded-2xl p-12 text-center">
      <span class="material-icons-outlined text-5xl text-blue-500 mb-4">cloud_upload</span>
      <p class="text-lg font-medium text-gray-700 dark:text-gray-200">Drop files here</p>
    </div>
  </div>
  <input type="file" id="file-input" class="hidden" multiple>

  <script>    // Theme management
    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDark = savedTheme === 'dark' || (!savedTheme && prefersDark);
      if (isDark) document.documentElement.classList.add('dark');
      updateModeBtnText();
    }
    
    function toggleTheme() {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
      updateModeBtnText();
    }
    
    function updateModeBtnText() {
      const icon = document.getElementById('mode-btn-icon');
      if (icon) icon.textContent = document.documentElement.classList.contains('dark') ? 'light_mode' : 'dark_mode';
    }

    // Auto-resize textarea
    function initTextarea() {
      const textarea = document.getElementById('message-input');
      
      if (!textarea) {
        console.error('Message input not found');
        return;
      }
      
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 192) + 'px';
        updateSendButton();
      });
      
      textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }
    
    function initKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + K to focus search
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          document.getElementById('sidebar-search-btn').click();
        }
        
        // Escape to close search
        if (e.key === 'Escape') {
          const searchBox = document.getElementById('sidebar-search-box');
          if (!searchBox.classList.contains('hidden')) {
            searchBox.classList.add('hidden');
          }
          // Also close any open dropdowns
          document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.remove('active');
          });
        }
        
        // Ctrl/Cmd + N for new chat
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
          e.preventDefault();
          document.getElementById('new-chat-btn').click();
        }
      });
    }
    
    function updateSendButton() {
      const textarea = document.getElementById('message-input');
      const sendBtn = document.getElementById('send-btn');
      sendBtn.disabled = !textarea.value.trim();
    }

    // Dropdown management
    function initDropdowns() {
      const dropdowns = ['assistant', 'model'];
      dropdowns.forEach(type => {
        const btn = document.getElementById(`${type}-selector`);
        const menu = document.getElementById(`${type}-dropdown`);
        
        if (!btn || !menu) {
          console.warn(`Dropdown elements not found for ${type}`);
          return;
        }
        
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          dropdowns.forEach(t => {
            if (t !== type) {
              const otherMenu = document.getElementById(`${t}-dropdown`);
              if (otherMenu) otherMenu.classList.remove('active');
            }
          });
          const isOpen = !menu.classList.contains('active');
          menu.classList.toggle('active');
          if (isOpen) {
            if (type === 'assistant' && typeof renderAssistantDropdown === 'function') renderAssistantDropdown();
            if (type === 'model' && typeof renderModelDropdown === 'function') renderModelDropdown();
            const rect = btn.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
            menu.style.minWidth = Math.max(rect.width, 200) + 'px';
          }
        });
        
        // Prevent menu from closing when clicking inside it
        menu.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      });
      
      document.addEventListener('click', () => {
        dropdowns.forEach(type => {
          const menu = document.getElementById(`${type}-dropdown`);
          if (menu) menu.classList.remove('active');
        });
      });
    }

    // Session management
    let currentSessionId = null;
    let currentGroupId = null;  // 群聊模式下的 group_id
    let groups = [];
    let assistants = [];
    let models = [];
    let skills = [];
    let selectedAssistant = localStorage.getItem('bee_assistant') || 'auto';
    let selectedModel = localStorage.getItem('bee_model') || 'default';
    let isGenerating = false;
    let sessionTokensAccum = 0;

    async function loadSessions() {
      try {
        const response = await fetch('/api/sessions');
        const sessions = await response.json();
        renderSessions(sessions);
      } catch (e) {
        console.error('Failed to load sessions:', e);
      }
    }

    async function loadGroups() {
      try {
        const response = await fetch('/api/groups');
        groups = await response.json();
        renderGroups();
      } catch (e) {
        console.error('Failed to load groups:', e);
      }
    }

    function renderGroups() {
      const list = document.getElementById('group-list');
      const section = document.getElementById('groups-section');
      if (groups.length === 0) {
        section.classList.add('hidden');
        return;
      }
      section.classList.remove('hidden');
      list.innerHTML = groups.map(g => {
        const name = g.name || g.id?.slice(0, 8) || '群聊';
        const isActive = currentGroupId === g.id;
        return `<li class="group-item ${isActive ? 'active' : ''}" data-group-id="${escapeHtml(g.id)}">
          <a href="#" class="flex items-start gap-3 px-4 py-3 rounded-lg hover:bg-white dark:hover:bg-gray-800 transition-colors group" onclick="loadGroup('${escapeHtml(g.id)}'); return false;">
            <span class="material-icons-outlined text-gray-400 mt-0.5 text-lg ${isActive ? 'text-green-500' : ''}">groups</span>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-text-main-light dark:text-text-main-dark truncate">${escapeHtml(name)}</p>
              <span class="text-xs text-text-sub-light dark:text-text-sub-dark">${(g.member_ids || []).length} 成员</span>
            </div>
          </a>
        </li>`;
      }).join('');
    }

    function loadGroup(groupId) {
      currentGroupId = groupId;
      currentSessionId = null;
      selectedAssistant = null;
      sessionTokensAccum = 0;
      updateTokenStats(0, 0);
      document.getElementById('assistant-selector').classList.add('hidden');
      document.getElementById('selected-assistant').textContent = '群聊';
      const inboxBtn = document.getElementById('inbox-process-btn');
      if (inboxBtn) {
        if (groupId.startsWith('p2p_')) {
          inboxBtn.classList.remove('hidden');
          inboxBtn.classList.add('flex');
        } else {
          inboxBtn.classList.add('hidden');
          inboxBtn.classList.remove('flex');
        }
      }
      try {
        fetch(`/api/history?group_id=${encodeURIComponent(groupId)}`)
          .then(r => r.json())
          .then(data => {
            showChatInterface();
            renderMessages(data.messages);
            updateSessionTitle(data.messages);
            highlightCurrentGroup();
          });
      } catch (e) {
        showToast('Failed to load group', 'error');
      }
    }

    function highlightCurrentGroup() {
      document.querySelectorAll('.group-item').forEach(item => {
        item.classList.toggle('active', item.dataset.groupId === currentGroupId);
      });
    }

    function renderSessions(sessions) {
      const list = document.getElementById('session-list');
      const empty = document.getElementById('empty-sessions');
      
      if (sessions.length === 0) {
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');
      
      const groups = groupSessionsByDate(sessions);
      
      list.innerHTML = Object.entries(groups).map(([date, items]) => `
        <div>
          <h3 class="px-4 text-xs font-semibold text-text-sub-light dark:text-text-sub-dark uppercase tracking-wider mb-2">${date}</h3>
          <ul class="space-y-1">
            ${items.map(session => {
              const safeId = escapeHtml(session.id);
              const safeTitle = escapeHtml(session.title);
              const isActive = currentSessionId && selectedAssistant && session.id === `${currentSessionId}::${selectedAssistant}`;
              return `
              <li class="session-item ${isActive ? 'active' : ''}" data-id="${safeId}">
                <a href="#" class="flex items-start gap-3 px-4 py-3 rounded-lg hover:bg-white dark:hover:bg-gray-800 transition-colors group" onclick="loadSession('${safeId}'); return false;">
                  <span class="material-icons-outlined text-gray-400 mt-0.5 text-lg ${isActive ? 'text-blue-500' : ''}">chat_bubble${isActive ? '' : '_outline'}</span>
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-text-main-light dark:text-text-main-dark truncate">${safeTitle}</p>
                    <div class="flex items-center justify-between mt-1">
                      <span class="text-xs text-text-sub-light dark:text-text-sub-dark">${session.message_count} msgs</span>
                      <span class="text-xs text-text-sub-light dark:text-text-sub-dark">${session.updated_at}</span>
                    </div>
                  </div>
                  <button class="delete-session-btn opacity-0 group-hover:opacity-100 p-1 hover:bg-red-100 dark:hover:bg-red-900 rounded transition-all" onclick="event.stopPropagation(); deleteSession('${safeId}')">
                    <span class="material-icons-outlined text-sm text-red-500">delete</span>
                  </button>
                </a>
              </li>
            `;}).join('')}
          </ul>
        </div>
      `).join('');
    }

    function groupSessionsByDate(sessions) {
      const groups = {};
      const today = new Date().toISOString().split('T')[0];
      const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
      
      sessions.forEach(session => {
        let groupName;
        if (session.date === today) groupName = 'Today';
        else if (session.date === yesterday) groupName = 'Yesterday';
        else if (new Date(session.date) > new Date(Date.now() - 7 * 86400000)) groupName = 'This Week';
        else groupName = 'Earlier';
        
        if (!groups[groupName]) groups[groupName] = [];
        groups[groupName].push(session);
      });
      
      return groups;
    }

    async function loadSession(sessionIdOrComposite) {
      currentGroupId = null;
      document.getElementById('assistant-selector').classList.remove('hidden');
      document.getElementById('inbox-process-btn')?.classList.add('hidden');
      const [sid, aid] = sessionIdOrComposite.includes('::') ? sessionIdOrComposite.split('::') : [sessionIdOrComposite, 'default'];
      currentSessionId = sid;
      selectedAssistant = aid || 'default';
      sessionTokensAccum = 0;
      updateTokenStats(0, 0);
      try {
        const response = await fetch(`/api/history?session_id=${encodeURIComponent(sid)}&assistant_id=${encodeURIComponent(selectedAssistant)}`);
        const data = await response.json();
        showChatInterface();
        renderMessages(data.messages);
        updateSessionTitle(data.messages);
        highlightCurrentSession();
      } catch (e) {
        showToast('Failed to load session', 'error');
      }
    }

    function showChatInterface() {
      document.getElementById('welcome-screen').classList.add('hidden');
      document.getElementById('messages').classList.remove('hidden');
    }

    function renderMessages(messages) {
      const container = document.getElementById('messages');
      container.innerHTML = messages.map(msg => renderMessage(msg)).join('');
      scrollToBottom();
    }

    function renderMessage(msg, isStreaming = false) {
      const isUser = msg.role === 'user';
      const content = isStreaming ? msg.content : marked.parse(msg.content);
      const asstName = msg.assistant_id && assistants.find(a => a.id === msg.assistant_id)?.name || (msg.assistant_id || 'Bee');
      
      return `
        <div class="msg-row ${msg.role} ${isStreaming ? 'streaming' : ''}">
          <div class="w-full ${isUser ? 'flex justify-end items-start' : ''}">
            <div class="${isUser 
              ? 'bg-gray-100 dark:bg-gray-800 text-text-main-light dark:text-text-main-dark rounded-2xl rounded-br-md w-fit max-w-3xl group' 
              : 'bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl rounded-bl-md group'} 
              px-5 py-4 max-w-3xl shadow-sm">
              ${!isUser ? `
                <div class="flex items-center gap-2 mb-2">
                  <span class="material-icons-outlined text-blue-500">smart_toy</span>
                  <span class="text-sm font-medium text-text-sub-light dark:text-text-sub-dark">${escapeHtml(asstName)}</span>
                </div>
              ` : ''}
              <div class="message-content ${isStreaming ? 'streaming' : ''}">
                ${content}
              </div>
              <div class="flex items-center gap-2 mt-3 opacity-0 group-hover:opacity-100 transition-opacity">
                <button type="button" onclick="copyMessage(this)" class="p-1.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors" title="复制">
                  <span class="material-icons-outlined text-sm">content_copy</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function updateSessionTitle(messages) {
      const firstUserMsg = messages.find(m => m.role === 'user');
      const title = firstUserMsg 
        ? firstUserMsg.content.substring(0, 50) + (firstUserMsg.content.length > 50 ? '...' : '')
        : 'New Chat';
      document.getElementById('current-session-title').textContent = title;
    }

    function highlightCurrentSession() {
      const activeId = currentSessionId && selectedAssistant ? `${currentSessionId}::${selectedAssistant}` : null;
      document.querySelectorAll('.session-item').forEach(item => {
        item.classList.toggle('active', item.dataset.id === activeId);
      });
    }

    async function sendMessage() {
      const textarea = document.getElementById('message-input');
      const message = textarea.value.trim();
      if (!message || isGenerating) return;
      
      showChatInterface();
      
      const messagesContainer = document.getElementById('messages');
      messagesContainer.insertAdjacentHTML('beforeend', renderMessage({ role: 'user', content: message }));
      textarea.value = '';
      textarea.style.height = 'auto';
      updateSendButton();
      scrollToBottom();
      
      const loadingId = 'loading-' + Date.now();
      messagesContainer.insertAdjacentHTML('beforeend', `
        <div id="${loadingId}" class="msg-row assistant">
          <div class="w-full">
            <div class="bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl rounded-bl-md px-5 py-4 shadow-sm inline-flex items-center gap-2">
              <span class="material-icons-outlined text-blue-500">smart_toy</span>
              <div class="flex gap-1">
                <span class="w-2 h-2 bg-blue-500 rounded-full typing-dot"></span>
                <span class="w-2 h-2 bg-blue-500 rounded-full typing-dot"></span>
                <span class="w-2 h-2 bg-blue-500 rounded-full typing-dot"></span>
              </div>
            </div>
          </div>
        </div>
      `);
      scrollToBottom();
      
      isGenerating = true;
      updateSendButtonState();
      typewriterControls?.show();
      
      try {
        const body = { message, model_id: selectedModel };
        if (currentGroupId) {
          body.group_id = currentGroupId;
          body.session_id = currentGroupId;
        } else {
          body.session_id = currentSessionId;
          body.assistant_id = selectedAssistant;
        }
        const response = await fetch('/api/chat/stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let assistantMessage = '';
        
        document.getElementById(loadingId).remove();
        
        const streamStartTime = Date.now();
        let thinkingStartTime = null;
        const isGroupMode = !!currentGroupId;
        const msgId = 'msg-' + Date.now();
        if (!isGroupMode) messagesContainer.insertAdjacentHTML('beforeend', `
          <div id="${msgId}" class="msg-row assistant">
            <div class="w-full">
              <div class="bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl rounded-bl-md px-5 py-4 max-w-3xl shadow-sm group">
                <div class="flex items-center justify-between gap-3 mb-2 flex-wrap">
                  <div class="flex items-center gap-2">
                    <span class="material-icons-outlined text-blue-500">smart_toy</span>
                    <span class="text-sm font-medium text-text-main-light dark:text-text-main-dark">Bee</span>
                  </div>
                  <div class="thinking-steps flex items-center gap-2" data-msg-id="${msgId}">
                    <div class="thinking-bar flex items-center gap-1" role="button" tabindex="0" title="展示/隐藏思考过程">
                      <span class="label"><span class="material-icons-outlined text-sm">psychology</span><span class="thinking-label">展示步骤</span></span>
                      <span class="arrow">›</span>
                    </div>
                    <span class="duration text-xs text-text-sub-light dark:text-text-sub-dark">0s</span>
                  </div>
                </div>
                <div class="steps-content mb-3"></div>
                <div class="message-content typewriter-active"></div>
                <div class="flex gap-2 mt-3 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button type="button" onclick="copyMessage(this)" class="p-1.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors" title="复制">
                    <span class="material-icons-outlined text-sm">content_copy</span>
                  </button>
                </div>
              </div>
          </div>
        </div>
        `);
        
        let msgEl = isGroupMode ? null : document.getElementById(msgId);
        let msgContent = msgEl?.querySelector('.message-content');
        const thinkingSteps = msgEl?.querySelector('.thinking-steps');
        let stepsContent = msgEl?.querySelector('.steps-content');
        const thinkingBar = msgEl?.querySelector('.thinking-bar');
        const durationEl = msgEl?.querySelector('.duration');
        let responseStarted = false;
        let typewriter = null;
        if (!isGroupMode && msgContent) {
          typewriter = new Typewriter(msgContent, {
          baseSpeed: 15,
          codeSpeed: 2,
          punctuationDelay: 120,
          paragraphDelay: 250,
          onUpdate: () => scrollToBottom(),
          onComplete: () => {
            msgContent.classList.remove('typewriter-active', 'streaming');
            msgContent.classList.add('streaming-complete');
            hljs.highlightAll();
            typewriterControls?.hide();
          }
        });
        typewriter.setSpeed(parseFloat(localStorage.getItem('typewriter_speed_preference') || '0.5'));
        typewriterControls?.setTypewriter(typewriter);
        }
        // Don't call start() here - appendText() will auto-start when chunks arrive
        
        const updateDuration = () => {
          const end = thinkingStartTime != null ? Date.now() : streamStartTime;
          const start = thinkingStartTime != null ? thinkingStartTime : streamStartTime;
          const sec = Math.round((end - start) / 1000);
          if (durationEl) durationEl.textContent = sec + 's';
        };
        const updateThinkingLabel = () => {
          const lb = msgEl?.querySelector('.thinking-label');
          const isHidden = stepsContent?.classList?.contains('hidden');
          if (lb) lb.textContent = isHidden ? '展示步骤' : '隐藏步骤';
          const arrow = msgEl?.querySelector('.thinking-bar .arrow');
          if (arrow) arrow.style.transform = isHidden ? 'rotate(-90deg)' : 'none';
        };
        thinkingBar?.addEventListener('click', () => {
          stepsContent?.classList?.toggle('hidden');
          updateThinkingLabel();
        });
        const addStep = (type, title, detail) => {
          if (!stepsContent) return;
          const step = document.createElement('div');
          step.className = `step-item ${type}`;
          step.innerHTML = detail ? `<div class="step-title">${escapeHtml(title)}</div><div class="step-detail">${escapeHtml(detail)}</div>` : `<div class="step-title">${escapeHtml(title)}</div>`;
          stepsContent.appendChild(step);
          updateDuration();
          scrollToBottom();
        };
        const hideStepsOnResponse = () => {
          if (!responseStarted && stepsContent && stepsContent.children.length > 0) {
            responseStarted = true;
            stepsContent.classList.add('hidden');
            updateThinkingLabel();
          }
        };
        
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();
          
          for (const line of lines) {
            if (!line.trim()) continue;
            try {
              const event = JSON.parse(line);
              if (event.type === 'session_id') {
                currentSessionId = event.session_id;
                if (currentGroupId) loadGroups(); else loadSessions();
              } else if (event.type === 'group_assistant_start') {
                const asstName = assistants.find(a => a.id === event.assistant_id)?.name || event.assistant_id || 'Assistant';
                const gMsgId = 'msg-' + Date.now() + '-' + (event.assistant_id || '');
                messagesContainer.insertAdjacentHTML('beforeend', `
                  <div id="${gMsgId}" class="msg-row assistant">
                    <div class="w-full">
                      <div class="bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl rounded-bl-md px-5 py-4 max-w-3xl shadow-sm group">
                        <div class="flex items-center gap-2 mb-2">
                          <span class="material-icons-outlined text-green-500">smart_toy</span>
                          <span class="text-sm font-medium text-text-sub-light dark:text-text-sub-dark">${escapeHtml(asstName)}</span>
                        </div>
                        <div class="message-content typewriter-active"></div>
                      </div>
                    </div>
                  </div>
                `);
                const gContent = document.querySelector(`#${gMsgId} .message-content`);
                if (typewriter) typewriter.finish();
                typewriter = new Typewriter(gContent, { baseSpeed: 15, codeSpeed: 2, pasteSpeed: 3 });
                assistantMessage = '';
                scrollToBottom();
              } else if (event.type === 'group_assistant_done') {
                if (typewriter) typewriter.finish();
              } else if (event.type === 'assistant_dispatched') {
                selectedAssistant = event.assistant_id;
                document.getElementById('selected-assistant').textContent = event.assistant_name;
              } else if (event.type === 'message_chunk') {
                hideStepsOnResponse();
                assistantMessage += event.text || '';
                typewriter?.appendText(event.text || '');
              } else if (event.type === 'stream') {
                hideStepsOnResponse();
                assistantMessage += event.content || '';
                typewriter?.appendText(event.content || '');
              } else if (event.type === 'thinking' && !isGroupMode) {
                if (thinkingStartTime == null) thinkingStartTime = Date.now();
                addStep('step-understand', '1. 理解问题', '正在分析用户问题…');
              } else if (event.type === 'thinking_content') {
                if (thinkingStartTime == null) thinkingStartTime = Date.now();
                const text = (event.text || '').trim();
                addStep('step-decompose', '2. 拆解与规划', text ? text.substring(0, 300) + (text.length > 300 ? '…' : '') : '规划中…');
              } else if (event.type === 'memory_recovery') {
                if (thinkingStartTime == null) thinkingStartTime = Date.now();
                const preview = (event.preview || '').trim();
                addStep('step-memory', '4. 组织上下文 · 使用长期记忆', preview ? preview.substring(0, 200) + (preview.length > 200 ? '…' : '') : '检索相关记忆');
              } else if (event.type === 'tool_call') {
                if (thinkingStartTime == null) thinkingStartTime = Date.now();
                addStep('step-tool tool-call', '3. 选择并调用工具', event.tool || '');
              } else if (event.type === 'observation') {
                if (thinkingStartTime == null) thinkingStartTime = Date.now();
                const prev = (event.preview || '').substring(0, 150);
                addStep('observation', '观察工具返回', event.tool ? `${event.tool}: ${prev}${(event.preview || '').length > 150 ? '…' : ''}` : prev || '');
              } else if (event.type === 'tool_failure') {
                if (thinkingStartTime == null) thinkingStartTime = Date.now();
                addStep('recovery', '工具失败', `${event.tool || ''}: ${event.reason || ''}`);
              } else if (event.type === 'recovery') {
                if (thinkingStartTime == null) thinkingStartTime = Date.now();
                addStep('recovery', '错误恢复', event.detail || event.action || '');
              } else if (event.type === 'memory_consolidation') {
                if (thinkingStartTime == null) thinkingStartTime = Date.now();
                const prev = (event.preview || '').trim().substring(0, 150);
                addStep('step-consolidate', '5. 整理到长期记忆', prev ? prev + ((event.preview || '').length > 150 ? '…' : '') : '写入长期记忆');
              } else if (event.type === 'token_usage') {
                const delta = event.total_tokens || 0;
                sessionTokensAccum += delta;
                const total = event.cumulative_total ?? sessionTokensAccum;
                updateTokenStats(sessionTokensAccum, total);
              } else if (event.type === 'error') {
                showToast(event.text || event.message || 'Error', 'error');
              }
            } catch (e) {
              console.error('Parse error:', e);
            }
          }
        }
        
        typewriter?.finish();
        updateDuration();
        if (thinkingSteps) {
          if (!stepsContent || stepsContent.children.length === 0) thinkingSteps.style.display = 'none';
          else updateThinkingLabel();
        }
        
      } catch (e) {
        showToast('Failed to send message', 'error');
        document.getElementById(loadingId)?.remove();
        typewriterControls?.hide();
      } finally {
        isGenerating = false;
        updateSendButtonState();
      }
    }

    function updateSendButtonState() {
      const sendBtn = document.getElementById('send-btn');
      sendBtn.innerHTML = isGenerating 
        ? '<span class="material-icons-outlined text-xl">stop</span>'
        : '<span class="material-icons-outlined text-xl">arrow_upward</span>';
    }

    function scrollToBottom() {
      const wrapper = document.getElementById('messages-wrapper');
      wrapper.scrollTop = wrapper.scrollHeight;
    }

    function initScrollButton() {
      const wrapper = document.getElementById('messages-wrapper');
      const btn = document.getElementById('scroll-bottom');
      
      wrapper.addEventListener('scroll', () => {
        const isNearBottom = wrapper.scrollHeight - wrapper.scrollTop - wrapper.clientHeight < 100;
        btn.classList.toggle('visible', !isNearBottom);
      });
      
      btn.addEventListener('click', scrollToBottom);
    }

    async function loadAssistants() {
      try {
        const response = await fetch('/api/assistants');
        if (!response.ok) throw new Error('Failed to fetch assistants');
        const list = (await response.json()).filter(a => a.id !== 'auto');
        assistants = [{ id: 'auto', name: 'Auto Helper', description: 'Automatically select the best assistant' }, ...list];
        console.log('Loaded assistants:', assistants);
        renderAssistantDropdown();
      } catch (e) {
        console.error('Failed to load assistants:', e);
        // Fallback data
        assistants = [
          { id: 'auto', name: 'Auto Helper', description: 'Automatically select the best assistant' },
          { id: 'default', name: 'General Assistant', description: 'All-purpose AI assistant' }
        ];
        renderAssistantDropdown();
      }
    }

    async function loadModels() {
      try {
        const response = await fetch('/api/models');
        if (!response.ok) throw new Error('Failed to fetch models');
        models = await response.json();
        if (!models.some(m => m.id === 'default')) {
          models = [{ id: 'default', name: 'Default (Config)' }, ...models];
        }
        console.log('Loaded models:', models);
        renderModelDropdown();
      } catch (e) {
        console.error('Failed to load models:', e);
        // Fallback data
        models = [
          { id: 'default', name: 'Default (Config)' },
          { id: 'deepseek-chat', name: 'DeepSeek Chat' }
        ];
        renderModelDropdown();
      }
    }

    function renderAssistantDropdown() {
      const dropdown = document.getElementById('assistant-dropdown');
      dropdown.innerHTML = assistants.map(a => `
        <div class="dropdown-item ${a.id === selectedAssistant ? 'selected' : ''}" data-id="${a.id}" data-name="${a.name}">
          <span class="material-icons-outlined text-sm">psychology</span>
          <div>
            <div class="font-medium">${escapeHtml(a.name)}</div>
            <div class="text-xs opacity-70">${a.description ? escapeHtml(a.description) : ''}</div>
          </div>
        </div>
      `).join('');
      
      dropdown.querySelectorAll('.dropdown-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          selectedAssistant = item.dataset.id;
          localStorage.setItem('bee_assistant', selectedAssistant);
          document.getElementById('selected-assistant').textContent = item.dataset.name;
          dropdown.classList.remove('active');
          renderAssistantDropdown();
        });
      });
      const sel = document.getElementById('selected-assistant');
      if (sel) sel.textContent = assistants.find(a => a.id === selectedAssistant)?.name || selectedAssistant;
    }

    function renderModelDropdown() {
      const dropdown = document.getElementById('model-dropdown');
      const enabledModels = getEnabledModels();
      const filteredModels = models.filter(m => enabledModels.includes(m.id));
      
      dropdown.innerHTML = filteredModels.map(m => `
        <div class="dropdown-item ${m.id === selectedModel ? 'selected' : ''}" data-id="${m.id}" data-name="${m.name}">
          <span class="material-icons-outlined text-sm text-yellow-500">auto_awesome</span>
          <span>${escapeHtml(m.name)}</span>
        </div>
      `).join('');
      
      dropdown.querySelectorAll('.dropdown-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          selectedModel = item.dataset.id;
          localStorage.setItem('bee_model', selectedModel);
          document.getElementById('selected-model').textContent = item.dataset.name;
          dropdown.classList.remove('active');
          renderModelDropdown();
        });
      });
      const selModel = document.getElementById('selected-model');
      const currentModel = filteredModels.find(m => m.id === selectedModel) || filteredModels[0];
      if (selModel && currentModel) selModel.textContent = currentModel.name;
    }
    
    function getEnabledModels() {
      const saved = localStorage.getItem('bee_enabled_models');
      if (saved) {
        try {
          return JSON.parse(saved);
        } catch (e) {}
      }
      return models.map(m => m.id);
    }

    function initSearch() {
      const searchBtn = document.getElementById('sidebar-search-btn');
      const searchBox = document.getElementById('sidebar-search-box');
      const searchInput = document.getElementById('session-search-input');
      const clearBtn = document.getElementById('search-clear');
      
      searchBtn.addEventListener('click', () => {
        searchBox.classList.toggle('hidden');
        if (!searchBox.classList.contains('hidden')) {
          searchInput.focus();
        }
      });
      
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        clearBtn.classList.toggle('hidden', !query);
        
        document.querySelectorAll('.session-item').forEach(item => {
          const title = item.querySelector('.truncate').textContent.toLowerCase();
          item.style.display = title.includes(query) ? '' : 'none';
        });
      });
      
      clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        clearBtn.classList.add('hidden');
        document.querySelectorAll('.session-item').forEach(item => {
          item.style.display = '';
        });
      });
    }

    function initNewChat() {
      const newGroupBtn = document.getElementById('new-group-btn');
      const newGroupModal = document.getElementById('new-group-modal');
      const newGroupClose = document.getElementById('new-group-close');
      const newGroupCreate = document.getElementById('new-group-create');
      const newGroupMembers = document.getElementById('new-group-members');
      const newGroupName = document.getElementById('new-group-name');
      
      if (newGroupBtn) newGroupBtn.addEventListener('click', () => {
        newGroupName.value = '';
        newGroupMembers.innerHTML = (assistants.filter(a => a.id !== 'auto') || []).map(a => `
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" class="rounded border-gray-300 dark:border-gray-600" value="${escapeHtml(a.id)}">
            <span class="text-sm text-gray-700 dark:text-gray-300">${escapeHtml(a.name || a.id)}</span>
          </label>
        `).join('');
        newGroupModal.classList.add('active');
      });
      if (newGroupClose) newGroupClose.addEventListener('click', () => newGroupModal.classList.remove('active'));
      if (newGroupCreate) newGroupCreate.addEventListener('click', async () => {
        const memberIds = Array.from(newGroupMembers.querySelectorAll('input:checked')).map(cb => cb.value);
        if (memberIds.length < 2) {
          showToast('请至少选择 2 个助手', 'error');
          return;
        }
        try {
          const res = await fetch('/api/groups', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: newGroupName.value.trim() || undefined, member_ids: memberIds })
          });
          if (!res.ok) throw new Error(await res.text());
          const group = await res.json();
          newGroupModal.classList.remove('active');
          await loadGroups();
          if (group && group.id) loadGroup(group.id);
          showToast('群聊已创建', 'success');
        } catch (e) {
          showToast('创建失败: ' + (e.message || 'unknown'), 'error');
        }
      });
      
      const newChatBtns = document.querySelectorAll('#new-chat-btn, #welcome-new-chat');
      newChatBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          currentSessionId = null;
          currentGroupId = null;
          document.getElementById('assistant-selector').classList.remove('hidden');
          document.getElementById('inbox-process-btn')?.classList.add('hidden');
          sessionTokensAccum = 0;
          updateTokenStats(0, 0);
          document.getElementById('messages').innerHTML = '';
          document.getElementById('messages').classList.add('hidden');
          document.getElementById('welcome-screen').classList.remove('hidden');
          document.getElementById('current-session-title').textContent = 'New Chat';
          highlightCurrentSession();
          highlightCurrentGroup();
          document.getElementById('message-input').focus();
        });
      });
    }

    async function deleteSession(sessionIdOrComposite) {
      if (!confirm('Delete this conversation?')) return;
      const [sid, aid] = sessionIdOrComposite.includes('::') ? sessionIdOrComposite.split('::') : [sessionIdOrComposite, 'default'];
      try {
        await fetch('/api/session/clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: sid, assistant_id: aid || 'default' })
        });
        
        if (currentSessionId === sid && selectedAssistant === (aid || 'default')) {
          currentSessionId = null;
          document.getElementById('messages').innerHTML = '';
          document.getElementById('messages').classList.add('hidden');
          document.getElementById('welcome-screen').classList.remove('hidden');
          document.getElementById('current-session-title').textContent = 'New Chat';
        }
        
        loadSessions();
        showToast('Conversation deleted', 'success');
      } catch (e) {
        showToast('Failed to delete conversation', 'error');
      }
    }

    function initSuggestions() {
      document.querySelectorAll('.suggestion-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.getElementById('message-input').value = btn.textContent.trim();
          document.getElementById('message-input').focus();
          updateSendButton();
        });
      });
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <span class="material-icons-outlined ${type === 'success' ? 'text-green-500' : type === 'error' ? 'text-red-500' : 'text-blue-500'}">
          ${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}
        </span>
        <span>${message}</span>
      `;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function initDragAndDrop() {
      const overlay = document.getElementById('drag-overlay');
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        document.body.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      document.body.addEventListener('dragenter', () => overlay.classList.add('active'));
      overlay.addEventListener('dragleave', () => overlay.classList.remove('active'));
      overlay.addEventListener('drop', (e) => {
        overlay.classList.remove('active');
        const files = e.dataTransfer.files;
        handleFiles(files);
      });
    }

    function handleFiles(files) {
      showToast(`${files.length} file(s) attached`, 'success');
    }

    function formatTokens(n) {
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return String(n);
    }
    function updateTokenStats(sessionTokens, totalTokens) {
      const sesEl = document.getElementById('token-stats-session');
      const totEl = document.getElementById('token-stats-total');
      if (sesEl) sesEl.textContent = 'This Session: ' + formatTokens(sessionTokens);
      if (totEl) totEl.textContent = 'Total: ' + formatTokens(totalTokens);
    }
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function copyMessage(btn) {
      const content = btn.closest('.msg-row').querySelector('.message-content').textContent;
      navigator.clipboard.writeText(content).then(() => {
        showToast('Copied to clipboard', 'success');
      });
    }

    document.getElementById('mode-btn')?.addEventListener('click', toggleTheme);

    document.getElementById('config-btn')?.addEventListener('click', openSettings);
    document.getElementById('sidebar-settings-btn')?.addEventListener('click', openSettings);
    document.getElementById('sidebar-settings-icon')?.addEventListener('click', openSettings);
    
    // Settings View (in main area)
    let previousView = null;
    
    function openSettings() {
      const settingsView = document.getElementById('settings-view');
      const messagesWrapper = document.getElementById('messages-wrapper');
      const inputArea = document.getElementById('input-area');
      
      if (!settingsView.classList.contains('hidden')) {
        return;
      }
      
      previousView = {
        messagesHidden: messagesWrapper.classList.contains('hidden'),
        inputHidden: inputArea.classList.contains('hidden')
      };
      
      messagesWrapper.classList.add('hidden');
      inputArea.classList.add('hidden');
      settingsView.classList.remove('hidden');
      
      loadSettingsViewValues();
    }
    
    function closeSettings() {
      const settingsView = document.getElementById('settings-view');
      const messagesWrapper = document.getElementById('messages-wrapper');
      const inputArea = document.getElementById('input-area');
      
      settingsView.classList.add('hidden');
      messagesWrapper.classList.remove('hidden');
      inputArea.classList.remove('hidden');
    }
    
    document.getElementById('settings-view-close')?.addEventListener('click', closeSettings);
    
    function loadSettingsViewValues() {
      // Theme
      const themeSelect = document.getElementById('settings-view-theme');
      const savedTheme = localStorage.getItem('theme') || 'system';
      if (themeSelect) themeSelect.value = savedTheme;
      
      // Typewriter
      const typewriterEnabled = localStorage.getItem('typewriter_enabled') !== 'false';
      const typewriterToggle = document.getElementById('settings-view-typewriter-toggle');
      if (typewriterToggle) typewriterToggle.classList.toggle('active', typewriterEnabled);
      const speedRow = document.getElementById('settings-view-speed-row');
      if (speedRow) speedRow.style.opacity = typewriterEnabled ? '1' : '0.5';
      
      const speed = parseFloat(localStorage.getItem('typewriter_speed') || '1');
      const speedInput = document.getElementById('settings-view-typewriter-speed');
      if (speedInput) speedInput.value = speed;
      
      // Auto scroll
      const autoScroll = localStorage.getItem('auto_scroll') !== 'false';
      const autoscrollToggle = document.getElementById('settings-view-autoscroll-toggle');
      if (autoscrollToggle) autoscrollToggle.classList.toggle('active', autoScroll);
      
      // Default assistant/model
      const defaultAssistant = localStorage.getItem('bee_assistant') || 'auto';
      const defaultModel = localStorage.getItem('bee_model') || 'default';
      
      const assistantSelect = document.getElementById('settings-view-default-assistant');
      if (assistantSelect) {
        assistantSelect.innerHTML = '<option value="auto">自动</option>';
        assistants.forEach(a => {
          const opt = document.createElement('option');
          opt.value = a.id;
          opt.textContent = a.name;
          opt.selected = a.id === defaultAssistant;
          assistantSelect.appendChild(opt);
        });
      }
      
      const modelSelect = document.getElementById('settings-view-default-model');
      if (modelSelect) {
        modelSelect.innerHTML = '<option value="default">默认</option>';
        models.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id;
          opt.textContent = m.name;
          opt.selected = m.id === defaultModel;
          modelSelect.appendChild(opt);
        });
      }
      
      // Load skills
      renderSettingsViewSkills();
      
      // Load enabled models
      renderSettingsViewModels();
    }
    
    function renderSettingsViewSkills() {
      const container = document.getElementById('settings-view-skills-list');
      if (!container) return;
      
      if (skills.length === 0) {
        container.innerHTML = '<div class="p-6 text-center text-gray-400 text-sm">暂无技能，请先添加技能</div>';
        return;
      }
      
      container.innerHTML = skills.map(skill => `
        <div class="settings-view-skill-item" data-id="${escapeHtml(skill.id)}">
          <div class="settings-view-skill-info">
            <div class="settings-view-skill-name">${escapeHtml(skill.name)}</div>
            <div class="settings-view-skill-desc">${escapeHtml(skill.description)}</div>
            ${skill.tags && skill.tags.length > 0 ? `
              <div class="settings-view-skill-tags">
                ${skill.tags.map(t => `<span class="settings-view-skill-tag">${escapeHtml(t)}</span>`).join('')}
              </div>
            ` : ''}
          </div>
          <button class="settings-view-skill-edit-btn" onclick="openSkillEdit('${escapeHtml(skill.id)}')">编辑</button>
        </div>
      `).join('');
    }
    
    function renderSettingsViewModels() {
      const container = document.getElementById('settings-view-models-list');
      if (!container) return;
      
      const enabledModels = getEnabledModels();
      container.innerHTML = '';
      
      models.forEach(m => {
        const item = document.createElement('div');
        item.className = 'settings-model-item';
        item.dataset.id = m.id;
        
        const checkbox = document.createElement('div');
        checkbox.className = 'settings-model-checkbox' + (enabledModels.includes(m.id) ? ' checked' : '');
        
        const name = document.createElement('span');
        name.className = 'settings-model-name';
        name.textContent = m.name;
        
        item.appendChild(checkbox);
        item.appendChild(name);
        
        item.addEventListener('click', () => {
          checkbox.classList.toggle('checked');
          saveSettingsViewModelSelection();
        });
        
        container.appendChild(item);
      });
    }
    
    function saveSettingsViewModelSelection() {
      const items = document.querySelectorAll('#settings-view-models-list .settings-model-item');
      const enabled = [];
      items.forEach(item => {
        if (item.querySelector('.settings-model-checkbox.checked')) {
          enabled.push(item.dataset.id);
        }
      });
      if (enabled.length === 0) {
        enabled.push('default');
        const firstItem = document.querySelector('#settings-view-models-list .settings-model-item[data-id="default"]');
        if (firstItem) firstItem.querySelector('.settings-model-checkbox').classList.add('checked');
      }
      setEnabledModels(enabled);
    }
    
    // Settings View event listeners
    document.getElementById('settings-view-theme')?.addEventListener('change', (e) => {
      const value = e.target.value;
      if (value === 'system') {
        localStorage.removeItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.classList.toggle('dark', prefersDark);
      } else {
        localStorage.setItem('theme', value);
        document.documentElement.classList.toggle('dark', value === 'dark');
      }
      updateModeBtnText();
    });
    
    document.getElementById('settings-view-typewriter-toggle')?.addEventListener('click', function() {
      this.classList.toggle('active');
      const enabled = this.classList.contains('active');
      localStorage.setItem('typewriter_enabled', enabled.toString());
      const speedRow = document.getElementById('settings-view-speed-row');
      if (speedRow) speedRow.style.opacity = enabled ? '1' : '0.5';
    });
    
    document.getElementById('settings-view-typewriter-speed')?.addEventListener('input', (e) => {
      localStorage.setItem('typewriter_speed', e.target.value);
    });
    
    document.getElementById('settings-view-autoscroll-toggle')?.addEventListener('click', function() {
      this.classList.toggle('active');
      localStorage.setItem('auto_scroll', this.classList.contains('active').toString());
    });
    
    document.getElementById('settings-view-default-assistant')?.addEventListener('change', (e) => {
      localStorage.setItem('bee_assistant', e.target.value);
      selectedAssistant = e.target.value;
      const opt = e.target.options[e.target.selectedIndex];
      document.getElementById('selected-assistant').textContent = opt.textContent;
    });
    
    document.getElementById('settings-view-default-model')?.addEventListener('change', (e) => {
      localStorage.setItem('bee_model', e.target.value);
      selectedModel = e.target.value;
      const opt = e.target.options[e.target.selectedIndex];
      document.getElementById('selected-model').textContent = opt.textContent;
    });
    
    document.getElementById('settings-view-models-all')?.addEventListener('click', () => {
      document.querySelectorAll('#settings-view-models-list .settings-model-checkbox').forEach(cb => {
        cb.classList.add('checked');
      });
      saveSettingsViewModelSelection();
    });
    
    document.getElementById('settings-view-models-none')?.addEventListener('click', () => {
      document.querySelectorAll('#settings-view-models-list .settings-model-checkbox').forEach(cb => {
        cb.classList.remove('checked');
      });
      const first = document.querySelector('#settings-view-models-list .settings-model-checkbox');
      if (first) first.classList.add('checked');
      saveSettingsViewModelSelection();
    });
    
    document.getElementById('settings-view-skills-refresh')?.addEventListener('click', async () => {
      await loadSkills();
      renderSettingsViewSkills();
      showToast('技能已刷新', 'success');
    });

    document.getElementById('settings-view-skills-import-openclaw')?.addEventListener('click', openOpenClawImport);
    
    document.getElementById('settings-view-clear-current')?.addEventListener('click', async () => {
      if (!currentSessionId) {
        showToast('没有活动的会话', 'info');
        return;
      }
      if (!confirm('确定要清除当前对话吗？此操作不可撤销。')) return;
      try {
        await fetch('/api/session/clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: currentSessionId, assistant_id: selectedAssistant || 'default' })
        });
        document.getElementById('messages').innerHTML = '';
        currentSessionId = null;
        loadSessions();
        closeSettings();
        showToast('当前对话已清除', 'success');
      } catch (e) {
        showToast('清除失败', 'error');
      }
    });
    
    document.getElementById('settings-view-clear-all')?.addEventListener('click', async () => {
      if (!confirm('确定要清除所有对话吗？此操作不可撤销。')) return;
      try {
        const sessions = await fetch('/api/sessions').then(r => r.json());
        for (const s of sessions) {
          await fetch('/api/session/clear', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ session_id: s.session_id || s.id.split('::')[0], assistant_id: s.assistant_id || 'default' })
          });
        }
        document.getElementById('messages').innerHTML = '';
        currentSessionId = null;
        loadSessions();
        closeSettings();
        showToast('所有对话已清除', 'success');
      } catch (e) {
        showToast('清除失败', 'error');
      }
    });
    
    function loadSettingsValues() {
      // Theme
      const themeSelect = document.getElementById('settings-theme');
      const savedTheme = localStorage.getItem('theme') || 'system';
      themeSelect.value = savedTheme;
      
      // Typewriter
      const typewriterEnabled = localStorage.getItem('typewriter_enabled') !== 'false';
      document.getElementById('settings-typewriter-toggle').classList.toggle('active', typewriterEnabled);
      document.getElementById('typewriter-speed-row').style.opacity = typewriterEnabled ? '1' : '0.5';
      
      const speed = parseFloat(localStorage.getItem('typewriter_speed') || '1');
      document.getElementById('settings-typewriter-speed').value = speed;
      
      // Auto scroll
      const autoScroll = localStorage.getItem('auto_scroll') !== 'false';
      document.getElementById('settings-autoscroll-toggle').classList.toggle('active', autoScroll);
      
      // Default assistant/model
      const defaultAssistant = localStorage.getItem('bee_assistant') || 'auto';
      const defaultModel = localStorage.getItem('bee_model') || 'default';
      
      const assistantSelect = document.getElementById('settings-default-assistant');
      assistantSelect.innerHTML = '<option value="auto">自动</option>';
      assistants.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = a.name;
        opt.selected = a.id === defaultAssistant;
        assistantSelect.appendChild(opt);
      });
      
      const modelSelect = document.getElementById('settings-default-model');
      modelSelect.innerHTML = '<option value="default">默认</option>';
      models.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.name;
        opt.selected = m.id === defaultModel;
        modelSelect.appendChild(opt);
      });
      
      // Load enabled models
      renderModelsCheckboxes();
      
      // Load skills
      loadSkills();
    }
    
    function setEnabledModels(ids) {
      localStorage.setItem('bee_enabled_models', JSON.stringify(ids));
      refreshModelDropdown();
    }
    
    function renderModelsCheckboxes() {
      const container = document.getElementById('settings-models-list');
      if (!container) return;
      
      const enabledModels = getEnabledModels();
      container.innerHTML = '';
      
      models.forEach(m => {
        const item = document.createElement('div');
        item.className = 'settings-model-item';
        item.dataset.id = m.id;
        
        const checkbox = document.createElement('div');
        checkbox.className = 'settings-model-checkbox' + (enabledModels.includes(m.id) ? ' checked' : '');
        
        const name = document.createElement('span');
        name.className = 'settings-model-name';
        name.textContent = m.name;
        
        item.appendChild(checkbox);
        item.appendChild(name);
        
        item.addEventListener('click', () => {
          checkbox.classList.toggle('checked');
          saveModelSelection();
        });
        
        container.appendChild(item);
      });
    }
    
    function saveModelSelection() {
      const items = document.querySelectorAll('#settings-models-list .settings-model-item');
      const enabled = [];
      items.forEach(item => {
        if (item.querySelector('.settings-model-checkbox.checked')) {
          enabled.push(item.dataset.id);
        }
      });
      if (enabled.length === 0) {
        enabled.push('default');
        const firstItem = document.querySelector('#settings-models-list .settings-model-item[data-id="default"]');
        if (firstItem) firstItem.querySelector('.settings-model-checkbox').classList.add('checked');
      }
      setEnabledModels(enabled);
    }
    
    function refreshModelDropdown() {
      renderModelDropdown();
    }
    
    document.getElementById('settings-close')?.addEventListener('click', closeSettings);
    document.getElementById('settings-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'settings-modal') closeSettings();
    });
    
    document.getElementById('settings-theme')?.addEventListener('change', (e) => {
      const value = e.target.value;
      if (value === 'system') {
        localStorage.removeItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.classList.toggle('dark', prefersDark);
      } else {
        localStorage.setItem('theme', value);
        document.documentElement.classList.toggle('dark', value === 'dark');
      }
      updateModeBtnText();
    });
    
    document.getElementById('settings-typewriter-toggle')?.addEventListener('click', function() {
      this.classList.toggle('active');
      const enabled = this.classList.contains('active');
      localStorage.setItem('typewriter_enabled', enabled.toString());
      document.getElementById('typewriter-speed-row').style.opacity = enabled ? '1' : '0.5';
    });
    
    document.getElementById('settings-typewriter-speed')?.addEventListener('input', (e) => {
      localStorage.setItem('typewriter_speed', e.target.value);
    });
    
    document.getElementById('settings-autoscroll-toggle')?.addEventListener('click', function() {
      this.classList.toggle('active');
      localStorage.setItem('auto_scroll', this.classList.contains('active').toString());
    });
    
    document.getElementById('settings-default-assistant')?.addEventListener('change', (e) => {
      localStorage.setItem('bee_assistant', e.target.value);
      selectedAssistant = e.target.value;
      const opt = e.target.options[e.target.selectedIndex];
      document.getElementById('selected-assistant').textContent = opt.textContent;
    });
    
    document.getElementById('settings-default-model')?.addEventListener('change', (e) => {
      localStorage.setItem('bee_model', e.target.value);
      selectedModel = e.target.value;
      const opt = e.target.options[e.target.selectedIndex];
      document.getElementById('selected-model').textContent = opt.textContent;
    });
    
    document.getElementById('settings-models-all')?.addEventListener('click', () => {
      document.querySelectorAll('#settings-models-list .settings-model-checkbox').forEach(cb => {
        cb.classList.add('checked');
      });
      saveModelSelection();
    });
    
    document.getElementById('settings-models-none')?.addEventListener('click', () => {
      document.querySelectorAll('#settings-models-list .settings-model-checkbox').forEach(cb => {
        cb.classList.remove('checked');
      });
      const first = document.querySelector('#settings-models-list .settings-model-checkbox');
      if (first) first.classList.add('checked');
      saveModelSelection();
    });
    
    document.getElementById('settings-clear-current')?.addEventListener('click', async () => {
      if (!currentSessionId) {
        showToast('没有活动的会话', 'info');
        return;
      }
      if (!confirm('确定要清除当前对话吗？此操作不可撤销。')) return;
      try {
        await fetch(`/api/sessions/${currentSessionId}`, { method: 'DELETE' });
        document.getElementById('messages').innerHTML = '';
        document.getElementById('welcome-screen').classList.remove('hidden');
        currentSessionId = null;
        loadSessions();
        closeSettings();
        showToast('当前对话已清除', 'success');
      } catch (e) {
        showToast('清除失败', 'error');
      }
    });
    
    document.getElementById('settings-clear-all')?.addEventListener('click', async () => {
      if (!confirm('确定要清除所有对话吗？此操作不可撤销。')) return;
      try {
        const sessions = await fetch('/api/sessions').then(r => r.json());
        for (const s of sessions) {
          await fetch(`/api/sessions/${s.id}`, { method: 'DELETE' });
        }
        document.getElementById('messages').innerHTML = '';
        document.getElementById('welcome-screen').classList.remove('hidden');
        currentSessionId = null;
        loadSessions();
        closeSettings();
        showToast('所有对话已清除', 'success');
      } catch (e) {
        showToast('清除失败', 'error');
      }
    });
    
    // Skills management
    async function loadSkills() {
      try {
        const response = await fetch('/api/skills');
        if (!response.ok) throw new Error('Failed to fetch skills');
        skills = await response.json();
        renderSkillsList();
        renderSettingsViewSkills();
      } catch (e) {
        console.error('Failed to load skills:', e);
        skills = [];
        renderSkillsList();
        renderSettingsViewSkills();
      }
    }
    
    function renderSkillsList() {
      const container = document.getElementById('settings-skills-list');
      if (!container) return;
      
      if (skills.length === 0) {
        container.innerHTML = '<div class="p-4 text-center text-gray-400 text-sm">暂无技能</div>';
        return;
      }
      
      container.innerHTML = skills.map(skill => `
        <div class="settings-skill-item" data-id="${escapeHtml(skill.id)}">
          <div class="settings-skill-info">
            <div class="settings-skill-name">${escapeHtml(skill.name)}</div>
            <div class="settings-skill-desc">${escapeHtml(skill.description)}</div>
            ${skill.tags && skill.tags.length > 0 ? `
              <div class="settings-skill-tags">
                ${skill.tags.map(t => `<span class="settings-skill-tag">${escapeHtml(t)}</span>`).join('')}
              </div>
            ` : ''}
          </div>
          <button class="settings-skill-edit-btn" onclick="openSkillEdit('${escapeHtml(skill.id)}')">编辑</button>
        </div>
      `).join('');
    }
    
    function openSkillEdit(skillId) {
      const skill = skills.find(s => s.id === skillId);
      if (!skill) return;
      
      document.getElementById('skill-edit-id').value = skill.id;
      document.getElementById('skill-edit-name').value = skill.name;
      document.getElementById('skill-edit-description').value = skill.description;
      document.getElementById('skill-edit-tags').value = (skill.tags || []).join(', ');
      document.getElementById('skill-edit-capability').value = skill.capability || '';
      document.getElementById('skill-edit-template').value = skill.template || '';
      
      document.getElementById('skill-edit-modal').classList.add('active');
    }
    
    function closeSkillEdit() {
      document.getElementById('skill-edit-modal').classList.remove('active');
    }
    
    async function saveSkillEdit() {
      const id = document.getElementById('skill-edit-id').value;
      const name = document.getElementById('skill-edit-name').value.trim();
      const description = document.getElementById('skill-edit-description').value.trim();
      const tagsStr = document.getElementById('skill-edit-tags').value.trim();
      const capability = document.getElementById('skill-edit-capability').value;
      const template = document.getElementById('skill-edit-template').value;
      
      if (!name) {
        showToast('技能名称不能为空', 'error');
        return;
      }
      
      const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];
      
      try {
        const response = await fetch(`/api/skills/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, description, tags, capability, template })
        });
        
        if (!response.ok) {
          const err = await response.text();
          throw new Error(err);
        }
        
        showToast('技能已保存', 'success');
        closeSkillEdit();
        await loadSkills();
      } catch (e) {
        showToast('保存失败: ' + e.message, 'error');
      }
    }
    
    document.getElementById('skill-edit-close')?.addEventListener('click', closeSkillEdit);
    document.getElementById('skill-edit-cancel')?.addEventListener('click', closeSkillEdit);
    document.getElementById('skill-edit-save')?.addEventListener('click', saveSkillEdit);
    document.getElementById('skill-edit-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'skill-edit-modal') closeSkillEdit();
    });
    document.getElementById('settings-skills-refresh')?.addEventListener('click', async () => {
      await loadSkills();
      showToast('技能已刷新', 'success');
    });

    function openOpenClawImport() {
      document.getElementById('openclaw-skill-json').value = '';
      document.getElementById('openclaw-skill-md').value = '';
      document.getElementById('openclaw-overwrite').checked = false;
      document.getElementById('openclaw-import-modal').classList.add('active');
    }

    function closeOpenClawImport() {
      document.getElementById('openclaw-import-modal').classList.remove('active');
    }

    async function saveOpenClawImport() {
      const skillJson = document.getElementById('openclaw-skill-json').value.trim();
      const skillMd = document.getElementById('openclaw-skill-md').value.trim();
      const overwrite = document.getElementById('openclaw-overwrite').checked;

      if (!skillJson) {
        showToast('请输入 skill.json 内容', 'error');
        return;
      }

      try {
        JSON.parse(skillJson);
      } catch (e) {
        showToast('skill.json 格式无效: ' + e.message, 'error');
        return;
      }

      try {
        const response = await fetch('/api/skills/import-openclaw', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            skill_json: skillJson,
            skill_md: skillMd || null,
            overwrite
          })
        });

        if (!response.ok) {
          const err = await response.text();
          throw new Error(err);
        }

        const result = await response.json();
        showToast(`技能 "${result.name}" 导入成功`, 'success');
        closeOpenClawImport();
        await loadSkills();
      } catch (e) {
        showToast('导入失败: ' + e.message, 'error');
      }
    }

    document.getElementById('settings-skills-import-openclaw')?.addEventListener('click', openOpenClawImport);
    document.getElementById('openclaw-import-close')?.addEventListener('click', closeOpenClawImport);
    document.getElementById('openclaw-import-cancel')?.addEventListener('click', closeOpenClawImport);
    document.getElementById('openclaw-import-save')?.addEventListener('click', saveOpenClawImport);
    document.getElementById('openclaw-import-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'openclaw-import-modal') closeOpenClawImport();
    });

    document.getElementById('expand-btn')?.addEventListener('click', () => {
      const textarea = document.getElementById('message-input');
      textarea.style.height = textarea.style.height === '300px' ? 'auto' : '300px';
    });

    document.getElementById('attach-btn')?.addEventListener('click', () => {
      document.getElementById('file-input').click();
    });

    document.getElementById('file-input')?.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFiles(e.target.files);
      }
    });

    document.getElementById('export-btn')?.addEventListener('click', () => {
      showToast('Export functionality coming soon', 'info');
    });

    document.getElementById('import-btn')?.addEventListener('click', () => {
      showToast('Import functionality coming soon', 'info');
    });

    document.getElementById('inbox-process-btn')?.addEventListener('click', async () => {
      if (!currentGroupId || !currentGroupId.startsWith('p2p_')) return;
      const g = groups.find(x => x.id === currentGroupId);
      const members = g?.member_ids || [];
      if (members.length === 0) return;
      const btn = document.getElementById('inbox-process-btn');
      if (btn) btn.disabled = true;
      try {
        let total = 0;
        for (const aid of members) {
          const res = await fetch('/api/inbox/process', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ assistant_id: aid })
          });
          const data = await res.json().catch(() => ({}));
          total += data.processed || 0;
        }
        showToast(total > 0 ? `处理了 ${total} 条未读` : '收件箱已空', total > 0 ? 'success' : 'info');
        if (currentGroupId) loadGroup(currentGroupId);
      } catch (e) {
        showToast('处理失败: ' + (e.message || 'unknown'), 'error');
      } finally {
        if (btn) btn.disabled = false;
      }
    });

    // Sidebar toggle
    function initSidebarToggle() {
      const toggle = document.getElementById('sidebar-toggle');
      const expandBtn = document.getElementById('sidebar-expand-btn');
      const newChatIcon = document.getElementById('sidebar-new-chat-icon');
      const sidebar = document.getElementById('sidebar');
      const newChatBtn = document.getElementById('new-chat-btn');
      
      function collapseSidebar() {
        if (window.innerWidth > 768) {
          sidebar.classList.add('collapsed');
        } else {
          sidebar.classList.remove('mobile-open');
        }
      }
      function expandSidebar() {
        if (window.innerWidth > 768) {
          sidebar.classList.remove('collapsed');
        } else {
          sidebar.classList.add('mobile-open');
        }
      }
      function toggleSidebar() {
        if (window.innerWidth > 768) {
          sidebar.classList.toggle('collapsed');
        } else {
          sidebar.classList.toggle('mobile-open');
        }
      }
      
      if (toggle) toggle.addEventListener('click', toggleSidebar);
      if (expandBtn) expandBtn.addEventListener('click', expandSidebar);
      if (newChatIcon && newChatBtn) newChatIcon.addEventListener('click', () => newChatBtn.click());
      const headerToggle = document.getElementById('header-sidebar-toggle');
      if (headerToggle) headerToggle.addEventListener('click', expandSidebar);
    }

    // Typewriter Effect Manager
    class Typewriter {
      constructor(element, options = {}) {
        this.element = element;
        this.text = '';
        this.displayedText = '';
        this.isRunning = false;
        this.isPaused = false;
        this.currentIndex = 0;
        
        // Speed settings (ms per character)
        this.baseSpeed = options.baseSpeed || 15;
        this.codeSpeed = options.codeSpeed || 2;
        this.punctuationDelay = options.punctuationDelay || 150;
        this.paragraphDelay = options.paragraphDelay || 300;
        
        // Speed multiplier (can be adjusted by user)
        this.speedMultiplier = parseFloat(localStorage.getItem('typewriter_speed') || '1');
        
        this.timeoutId = null;
        this.onComplete = options.onComplete || (() => {});
        this.onUpdate = options.onUpdate || (() => {});
        
        // Chunk buffer for smooth streaming
        this.chunkBuffer = '';
        this.isInCodeBlock = false;
        this.pendingMarkdown = '';
        this.streamEnded = false;
      }
      
      setText(text) {
        this.text = text;
        this.chunkBuffer += text.slice(this.currentIndex);
      }
      
      appendText(text) {
        this.text += text;
        this.chunkBuffer += text;
        
        // If typewriter disabled, show immediately
        if (localStorage.getItem('typewriter_enabled') === 'false') {
          this.displayedText = this.text;
          this.currentIndex = this.text.length;
          this.render();
          return;
        }
        
        if (!this.isRunning && this.currentIndex < this.text.length) {
          this.start();
        }
      }
      
      start() {
        if (this.isRunning) return;
        
        // Check if typewriter effect is disabled
        if (localStorage.getItem('typewriter_enabled') === 'false') {
          this.displayedText = this.text;
          this.currentIndex = this.text.length;
          this.render();
          this.onComplete();
          return;
        }
        
        this.isRunning = true;
        this.isPaused = false;
        this.typeNext();
      }
      
      pause() {
        this.isPaused = true;
        if (this.timeoutId) {
          clearTimeout(this.timeoutId);
          this.timeoutId = null;
        }
      }
      
      resume() {
        if (!this.isPaused) return;
        this.isPaused = false;
        this.typeNext();
      }
      
      stop() {
        this.isRunning = false;
        this.isPaused = false;
        this.streamEnded = false;
        if (this.timeoutId) {
          clearTimeout(this.timeoutId);
          this.timeoutId = null;
        }
        // Display all remaining text immediately
        this.displayedText = this.text;
        this.render();
        this.onComplete();
      }
      
      // Stream ended - continue typing remaining text gracefully
      finish() {
        this.streamEnded = true;
        // If not currently running but has remaining text, start typing
        if (!this.isRunning && this.currentIndex < this.text.length) {
          this.start();
        }
        // If already running, it will complete naturally
        // If no text or already complete, trigger completion
        if (this.currentIndex >= this.text.length) {
          this.onComplete();
        }
      }
      
      setSpeed(multiplier) {
        this.speedMultiplier = Math.max(0.1, Math.min(3, multiplier));
        localStorage.setItem('typewriter_speed', this.speedMultiplier.toString());
      }
      
      getDelay(char, nextChar = '') {
        // Fast mode for code blocks
        if (this.isInCodeBlock) {
          return this.codeSpeed / this.speedMultiplier;
        }
        
        // Check if entering or leaving code block
        if (char === '`' && nextChar === '`' && this.text[this.currentIndex - 1] === '`') {
          this.isInCodeBlock = !this.isInCodeBlock;
          return 0;
        }
        
        // Longer pause for punctuation
        if ('.!?。！？'.includes(char)) {
          return this.punctuationDelay / this.speedMultiplier;
        }
        
        // Medium pause for commas and semicolons
        if (',;，；:：'.includes(char)) {
          return this.punctuationDelay / 2 / this.speedMultiplier;
        }
        
        // Pause for newlines (paragraph breaks)
        if (char === '\n' && nextChar === '\n') {
          return this.paragraphDelay / this.speedMultiplier;
        }
        
        // Base typing speed
        return this.baseSpeed / this.speedMultiplier;
      }
      
      typeNext() {
        if (!this.isRunning || this.isPaused) return;
        
        // Type multiple characters at once for smoother feel
        const charsPerTick = this.isInCodeBlock ? 10 : (this.speedMultiplier > 2 ? 3 : 1);
        let charsToType = 0;
        let delay = 0;
        
        for (let i = 0; i < charsPerTick && this.currentIndex + i < this.text.length; i++) {
          const char = this.text[this.currentIndex + i];
          const nextChar = this.text[this.currentIndex + i + 1] || '';
          charsToType++;
          
          // Check for markdown patterns that should be typed together
          if (char === '\n' && nextChar === '\n') {
            delay = this.getDelay(char, nextChar);
            break;
          }
          
          // Stop at punctuation for natural feel
          if (!this.isInCodeBlock && '.!?。！？'.includes(char)) {
            delay = this.getDelay(char, nextChar);
            break;
          }
        }
        
        this.currentIndex += charsToType;
        this.displayedText = this.text.slice(0, this.currentIndex);
        this.render();
        this.onUpdate(this.displayedText);
        
        if (this.currentIndex < this.text.length) {
          const nextDelay = delay || this.getDelay(
            this.text[this.currentIndex - 1] || '',
            this.text[this.currentIndex] || ''
          );
          this.timeoutId = setTimeout(() => this.typeNext(), nextDelay);
        } else {
          this.isRunning = false;
          // If stream ended and all text typed, trigger completion
          if (this.streamEnded) {
            this.onComplete();
          }
        }
      }
      
      render() {
        // Use marked.parse for markdown rendering
        // But only render up to current index
        const textToRender = this.displayedText;
        
        // Check if we're in the middle of a markdown pattern
        let renderText = textToRender;
        
        // Complete incomplete code blocks to prevent rendering issues
        const codeBlockMatches = (renderText.match(/```/g) || []).length;
        if (codeBlockMatches % 2 === 1) {
          renderText += '\n```';
        }
        
        // Complete incomplete inline code
        const backtickMatches = (renderText.match(/`/g) || []).length;
        if (backtickMatches % 2 === 1) {
          renderText += '`';
        }
        
        // Complete incomplete bold/italic markers
        const asteriskMatches = (renderText.match(/\*/g) || []).length;
        if (asteriskMatches % 2 === 1) {
          renderText += '*';
        }
        
        this.element.innerHTML = marked.parse(renderText);
      }
      
      get isActive() {
        return this.isRunning && !this.isPaused;
      }
      
      get progress() {
        return this.text.length > 0 ? this.currentIndex / this.text.length : 0;
      }
    }

    // Typewriter speed control UI
    function createTypewriterControls() {
      const controls = document.createElement('div');
      controls.id = 'typewriter-controls';
      controls.className = 'typewriter-controls';
      controls.innerHTML = `
        <div class="typewriter-controls-inner">
          <button id="tw-pause" class="tw-btn" title="暂停/继续">
            <span class="material-icons-outlined">pause</span>
          </button>
          <div class="tw-speed-group">
            <span class="tw-label">速度</span>
            <button class="tw-speed-btn active" data-speed="0.5">0.5x</button>
            <button class="tw-speed-btn" data-speed="1">1x</button>
            <button class="tw-speed-btn" data-speed="2">2x</button>
            <button class="tw-speed-btn" data-speed="3">3x</button>
          </div>
          <button id="tw-skip" class="tw-btn" title="跳过动画">
            <span class="material-icons-outlined">skip_next</span>
          </button>
        </div>
      `;
      
      // Add styles
      const style = document.createElement('style');
      style.textContent = `
        .typewriter-controls {
          position: fixed;
          bottom: 140px;
          left: 50%;
          transform: translateX(-50%);
          z-index: 100;
          opacity: 0;
          visibility: hidden;
          transition: all 0.3s ease;
        }
        .typewriter-controls.visible {
          opacity: 1;
          visibility: visible;
        }
        .typewriter-controls-inner {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 8px 16px;
          background: rgba(255, 255, 255, 0.95);
          border: 1px solid #e5e7eb;
          border-radius: 24px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.1);
          backdrop-filter: blur(10px);
        }
        .dark .typewriter-controls-inner {
          background: rgba(31, 41, 55, 0.95);
          border-color: #374151;
        }
        .tw-btn {
          display: flex;
          align-items: center;
          justify-content: center;
          width: 36px;
          height: 36px;
          border: none;
          border-radius: 50%;
          background: #f3f4f6;
          color: #6b7280;
          cursor: pointer;
          transition: all 0.2s;
        }
        .dark .tw-btn {
          background: #374151;
          color: #9ca3af;
        }
        .tw-btn:hover {
          background: #e5e7eb;
          color: #374151;
        }
        .dark .tw-btn:hover {
          background: #4b5563;
          color: #e5e7eb;
        }
        .tw-speed-group {
          display: flex;
          align-items: center;
          gap: 4px;
        }
        .tw-label {
          font-size: 12px;
          color: #9ca3af;
          margin-right: 4px;
        }
        .tw-speed-btn {
          padding: 4px 10px;
          border: 1px solid #e5e7eb;
          border-radius: 12px;
          background: transparent;
          font-size: 12px;
          color: #6b7280;
          cursor: pointer;
          transition: all 0.2s;
        }
        .dark .tw-speed-btn {
          border-color: #4b5563;
          color: #9ca3af;
        }
        .tw-speed-btn:hover {
          background: #f3f4f6;
        }
        .dark .tw-speed-btn:hover {
          background: #374151;
        }
        .tw-speed-btn.active {
          background: #3b82f6;
          border-color: #3b82f6;
          color: white;
        }
        
        /* Enhanced cursor animation */
        .message-content.typewriter-active::after {
          content: '▋';
          display: inline-block;
          animation: typewriter-cursor 0.8s ease-in-out infinite;
          color: #3b82f6;
          margin-left: 2px;
          font-weight: 300;
        }
        .dark .message-content.typewriter-active::after {
          color: #60a5fa;
        }
        @keyframes typewriter-cursor {
          0%, 100% { opacity: 1; }
          50% { opacity: 0; }
        }
        
        /* Character highlight effect */
        .typewriter-char {
          animation: char-appear 0.15s ease-out;
        }
        @keyframes char-appear {
          0% { opacity: 0; transform: translateY(2px); }
          100% { opacity: 1; transform: translateY(0); }
        }
      `;
      document.head.appendChild(style);
      document.body.appendChild(controls);
      
      // Event handlers
      let currentTypewriter = null;
      
      document.getElementById('tw-pause')?.addEventListener('click', () => {
        if (currentTypewriter) {
          if (currentTypewriter.isPaused) {
            currentTypewriter.resume();
            document.querySelector('#tw-pause .material-icons-outlined').textContent = 'pause';
          } else {
            currentTypewriter.pause();
            document.querySelector('#tw-pause .material-icons-outlined').textContent = 'play_arrow';
          }
        }
      });
      
      document.getElementById('tw-skip')?.addEventListener('click', () => {
        if (currentTypewriter) {
          currentTypewriter.stop();
        }
      });
      
      document.querySelectorAll('.tw-speed-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          document.querySelectorAll('.tw-speed-btn').forEach(b => b.classList.remove('active'));
          e.target.classList.add('active');
          const speed = parseFloat(e.target.dataset.speed);
          if (currentTypewriter) {
            currentTypewriter.setSpeed(speed);
          }
          // Save preference
          localStorage.setItem('typewriter_speed_preference', speed.toString());
        });
      });
      
      // Set initial speed from preference
      const savedSpeed = localStorage.getItem('typewriter_speed_preference') || '0.5';
      document.querySelectorAll('.tw-speed-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.speed === savedSpeed);
      });
      
      return {
        show: () => {}, // 禁用速度调整弹框
        hide: () => controls.classList.remove('visible'),
        setTypewriter: (tw) => { currentTypewriter = tw; }
      };
    }

    // Global typewriter controls
    let typewriterControls = null;

    document.addEventListener('DOMContentLoaded', () => {
      console.log('Bee Chat initializing...');
      
      // Initialize typewriter controls
      typewriterControls = createTypewriterControls();
      
      initTheme();
      initTextarea();
      initDropdowns();
      initScrollButton();
      initSearch();
      initNewChat();
      initSuggestions();
      initDragAndDrop();
      initSidebarToggle();
      initKeyboardShortcuts();
      
      // Test API endpoints
      console.log('Loading sessions, assistants, models, skills...');
      loadSessions();
      loadModels();
      loadSkills();
      Promise.all([loadAssistants(), loadGroups()]).then(() => {
        const params = new URLSearchParams(window.location.search);
        const aid = params.get('assistant_id');
        const gid = params.get('group_id');
        if (gid && groups.some(g => g.id === gid)) {
          loadGroup(gid);
        } else if (aid) {
          selectedAssistant = assistants.some(a => a.id === aid) ? aid : selectedAssistant;
          if (assistants.some(a => a.id === aid)) {
            currentGroupId = null;
            document.getElementById('assistant-selector').classList.remove('hidden');
            document.getElementById('inbox-process-btn')?.classList.add('hidden');
            document.getElementById('selected-assistant').textContent = assistants.find(a => a.id === aid)?.name || aid;
          }
        }
      });
      
      document.getElementById('send-btn').addEventListener('click', sendMessage);
      
      console.log('Bee Chat initialized');
    });
  </script>
</body>
</html>
