<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bee Personal AI Chat</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            primary: "#374151",
            "primary-hover": "#1F2937",
            "accent-blue": "#E0F2FE",
            "background-light": "#F9FAFB",
            "background-dark": "#111827",
            "surface-light": "#FFFFFF",
            "surface-dark": "#1F2937",
            "border-light": "#E5E7EB",
            "border-dark": "#374151",
            "text-main-light": "#111827",
            "text-main-dark": "#F9FAFB",
            "text-sub-light": "#6B7280",
            "text-sub-dark": "#9CA3AF",
          },
          fontFamily: {
            display: ["Inter", "system-ui", "sans-serif"],
            body: ["Inter", "system-ui", "sans-serif"],
          },
          borderRadius: {
            'xl': '1rem',
            '2xl': '1.5rem',
            '3xl': '2rem',
          },
        },
      },
    };
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
  <script src="/js/marked.min.js"></script>
  <link rel="stylesheet" href="/css/github-dark.min.css" id="hljs-theme">
  <script src="/js/highlight.min.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background-color: #D1D5DB; border-radius: 20px; }
    .dark ::-webkit-scrollbar-thumb { background-color: #4B5563; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in-up { animation: fadeInUp 0.5s ease-out; }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .typing-dot { animation: bounce 1.4s ease-in-out infinite; }
    .typing-dot:nth-child(1) { animation-delay: 0s; }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes cursor-blink { 50% { opacity: 0; } }
    .message-content.streaming::after { content: '‚ñã'; animation: cursor-blink 1s step-end infinite; color: #3b82f6; margin-left: 2px; }
    .dark .message-content.streaming::after { color: #60a5fa; }
    
    .code-block-wrapper { position: relative; margin: 1em 0; background: #1e293b; border-radius: 8px; overflow: hidden; }
    .code-block-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 14px; background: rgba(255,255,255,0.03); border-bottom: 1px solid rgba(255,255,255,0.08); }
    .code-block-lang { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; font-family: monospace; }
    .code-block-btn { padding: 4px 10px; border: none; border-radius: 4px; background: #334155; color: #94a3b8; font-size: 0.7rem; cursor: pointer; transition: all 0.2s; }
    .code-block-btn:hover { background: #4a5568; color: #fff; }
    .code-block-content { display: flex; overflow-x: auto; }
    .line-numbers { padding: 14px 8px 14px 14px; background: rgba(0,0,0,0.2); color: #64748b; font-size: 0.9em; font-family: monospace; line-height: 1.5; text-align: right; user-select: none; border-right: 1px solid rgba(255,255,255,0.08); }
    .code-with-lines { flex: 1; padding: 14px; overflow-x: auto; }
    
    .dropdown-menu { 
      position: fixed;
      margin-bottom: 8px;
      max-height: 280px;
      overflow-y: auto;
      background: white; 
      border: 1px solid #E5E7EB; 
      border-radius: 12px; 
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      min-width: 200px;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: all 0.2s ease;
    }
    .dark .dropdown-menu { 
      background: #1F2937; 
      border-color: #374151;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    }
    .dropdown-menu.active { opacity: 1; visibility: visible; transform: translateY(0); }
    .dropdown-item { 
      padding: 10px 14px; 
      cursor: pointer; 
      display: flex; 
      align-items: center; 
      gap: 10px;
      transition: background 0.15s;
    }
    .dropdown-item:first-child { border-radius: 12px 12px 0 0; }
    .dropdown-item:last-child { border-radius: 0 0 12px 12px; }
    .dropdown-item:hover { background: #F3F4F6; }
    .dark .dropdown-item:hover { background: #374151; }
    .dropdown-item.selected { background: #E0F2FE; color: #0369a1; }
    .dark .dropdown-item.selected { background: rgba(14,165,233,0.2); color: #38bdf8; }
    
    .msg-row.user { min-height: 0; }
    .msg-row.user .message-content { line-height: 1.6; }
    .message-content { line-height: 1.7; user-select: text; -webkit-user-select: text; }
    .message-content p { margin: 0.5em 0; }
    .message-content p:first-child { margin-top: 0; }
    .message-content p:last-child { margin-bottom: 0; }
    .message-content ul, .message-content ol { margin: 0.5em 0; padding-left: 1.5em; }
    .message-content li { margin: 0.25em 0; }
    .message-content code { background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; font-size: 0.9em; font-family: monospace; }
    .dark .message-content code { background: rgba(255,255,255,0.1); }
    .message-content pre { margin: 0.8em 0; }
    .message-content a { color: #3b82f6; text-decoration: none; }
    .message-content a:hover { text-decoration: underline; }
    .message-content blockquote { margin: 0.5em 0; padding-left: 1em; border-left: 3px solid #d1d5db; color: #6b7280; }
    .dark .message-content blockquote { border-color: #4b5563; color: #9ca3af; }
    
    .thinking-bar { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; margin-bottom: 8px; cursor: pointer; user-select: none; flex-shrink: 0; }
    .thinking-bar:hover { opacity: 0.9; }
    .thinking-bar .label { font-size: 0.8rem; color: #6b7280; display: flex; align-items: center; gap: 6px; }
    .dark .thinking-bar .label { color: #9ca3af; }
    .thinking-bar .arrow { font-size: 1rem; color: #9ca3af; transition: transform 0.2s; margin-left: 8px; }
    .thinking-steps .arrow { transition: transform 0.2s; }
    .thinking-bar .duration { font-size: 0.75rem; color: #9ca3af; }
    .thinking-steps { transition: all 0.2s; }
    .thinking-steps.collapsed .steps-content { display: none; }
    .step-item { font-size: 0.8rem; padding: 6px 10px; margin: 4px 0; background: rgba(0,0,0,0.03); border-radius: 8px; border-left: 3px solid #3b82f6; }
    .dark .step-item { background: rgba(255,255,255,0.05); }
    .step-item.tool-call { border-color: #f59e0b; }
    .step-item.observation { border-color: #10b981; }
    .step-item.recovery { border-color: #ef4444; }
    
    .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
    .toast { 
      background: white; 
      border: 1px solid #E5E7EB; 
      border-radius: 10px; 
      padding: 12px 16px; 
      min-width: 280px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.9rem;
      animation: toastEnter 0.3s ease;
    }
    .dark .toast { background: #1F2937; border-color: #374151; }
    @keyframes toastEnter { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    .toast-success { border-left: 3px solid #22c55e; }
    .toast-error { border-left: 3px solid #ef4444; }
    
    .drag-overlay { position: fixed; inset: 0; background: rgba(59, 130, 246, 0.15); backdrop-filter: blur(2px); z-index: 999; display: none; align-items: center; justify-content: center; }
    .drag-overlay.active { display: flex; }
    
    .scroll-bottom { 
      position: fixed; 
      bottom: 120px; 
      right: 24px; 
      width: 44px; 
      height: 44px; 
      border: none; 
      border-radius: 50%; 
      background: #374151; 
      color: white; 
      cursor: pointer;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s;
      box-shadow: 0 4px 14px rgba(0,0,0,0.2);
    }
    .dark .scroll-bottom { background: #4b5563; }
    .scroll-bottom.visible { opacity: 1; transform: translateY(0); }
    .scroll-bottom:hover { background: #1f2937; transform: translateY(-2px); }
    
    /* Sidebar collapse - desktop */
    aside { transition: width 0.3s; }
    aside .sidebar-content { display: flex; flex-direction: column; flex: 1; min-width: 0; overflow: hidden; }
    aside .sidebar-icon-bar { display: none; flex-direction: column; align-items: center; padding: 16px 0; gap: 8px; }
    aside .sidebar-icon-bar button { width: 40px; height: 40px; border: none; border-radius: 10px; background: transparent; color: #6b7280; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s; }
    aside .sidebar-icon-bar button:hover { background: rgba(0,0,0,0.08); }
    .dark aside .sidebar-icon-bar button:hover { background: rgba(255,255,255,0.08); }
    @media (min-width: 769px) {
      aside.collapsed { width: 64px !important; min-width: 64px; }
      aside.collapsed .sidebar-content { display: none; }
      aside.collapsed .sidebar-icon-bar { display: flex; }
    }
    
    /* Mobile sidebar */
    @media (max-width: 768px) {
      aside { position: fixed; width: 320px !important; transform: translateX(-100%); transition: transform 0.3s; z-index: 100; }
      aside.mobile-open { transform: translateX(0); }
      aside .sidebar-icon-bar { display: none !important; }
      aside.collapsed .sidebar-content { display: flex !important; }
      main { margin-left: 0; }
    }
    
    /* Button hover states */
    button { cursor: pointer; }
    button:disabled { cursor: not-allowed; }
    
    /* Session item active state */
    .session-item.active { background: white; }
    .dark .session-item.active { background: #1f2937; }
    .session-item.active a { border-left: 3px solid #3b82f6; }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-text-main-light dark:text-text-main-dark h-screen flex overflow-hidden">
  <aside id="sidebar" class="w-80 bg-[#F3F4F6] dark:bg-[#1a2233] flex flex-col border-r border-border-light dark:border-border-dark flex-shrink-0 h-full">
    <div class="sidebar-icon-bar">
      <button type="button" id="sidebar-expand-btn" title="Â±ïÂºÄ‰æßËæπÊ†è"><span class="material-icons-outlined">menu</span></button>
      <button type="button" id="sidebar-new-chat-icon" title="Êñ∞ÂØπËØù"><span class="material-icons-outlined">edit_note</span></button>
    </div>
    <div class="sidebar-content">
    <div class="h-16 flex items-center justify-between px-4 mt-2">
      <div class="flex items-center gap-3">
        <button id="sidebar-toggle" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-text-sub-light dark:text-text-sub-dark">
          <span class="material-icons-outlined text-xl">menu</span>
        </button>
        <h1 class="font-bold text-xl tracking-tight text-text-main-light dark:text-text-main-dark flex items-center gap-1">
          Bee <span class="font-semibold text-gray-500 dark:text-gray-400">Chat</span>
        </h1>
      </div>
      <button id="sidebar-search-btn" class="p-2 rounded-lg bg-white dark:bg-gray-800 shadow-sm border border-border-light dark:border-border-dark hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors">
        <span class="material-icons-outlined text-gray-500 dark:text-gray-400 text-lg">search</span>
      </button>
    </div>
    
    <div id="sidebar-search-box" class="hidden px-4 pb-2">
      <div class="relative">
        <input type="text" id="session-search-input" placeholder="ÊêúÁ¥¢‰ºöËØù..." 
          class="w-full px-4 py-2 pl-10 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
        <span class="material-icons-outlined absolute left-3 top-2 text-gray-400 text-sm">search</span>
        <button id="search-clear" class="hidden absolute right-2 top-1.5 p-1 text-gray-400 hover:text-gray-600">
          <span class="material-icons-outlined text-sm">close</span>
        </button>
      </div>
      <div id="search-stats" class="hidden text-xs text-gray-400 mt-2 px-1"></div>
    </div>
    
    <div class="px-4 py-4">
      <button id="new-chat-btn" class="w-full flex items-center gap-3 px-4 py-3 bg-white dark:bg-gray-800 border border-transparent dark:border-gray-700 hover:border-gray-300 dark:hover:border-gray-600 rounded-xl shadow-sm hover:shadow text-text-main-light dark:text-text-main-dark transition-all duration-200 group">
        <span class="material-icons-outlined text-blue-500 group-hover:scale-110 transition-transform">edit_note</span>
        <span class="font-medium">New Chat</span>
      </button>
    </div>
    
    <div id="session-list" class="flex-1 overflow-y-auto px-2 pb-4 space-y-6 no-scrollbar">
      <div id="empty-sessions" class="hidden px-4 py-8 text-center text-gray-400">
        <span class="material-icons-outlined text-4xl mb-2">chat_bubble_outline</span>
        <p class="text-sm">ËøòÊ≤°Êúâ‰ºöËØù</p>
        <p class="text-xs mt-1 opacity-70">ÁÇπÂáª‰∏äÊñπÊåâÈíÆÂºÄÂßãÊñ∞ÂØπËØù</p>
      </div>
    </div>
    </div>
  </aside>

  <main class="flex-1 flex flex-col h-full bg-surface-light dark:bg-background-dark relative">
    <header class="h-16 flex items-center justify-between px-8 border-b border-transparent dark:border-border-dark flex-shrink-0">
      <div class="flex items-center gap-3">
        <button id="header-sidebar-toggle" class="md:hidden p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700" title="ÊâìÂºÄ‰æßËæπÊ†è"><span class="material-icons-outlined">menu</span></button>
        <h2 id="current-session-title" class="text-lg text-text-sub-light dark:text-text-sub-dark font-normal truncate max-w-md">New Chat</h2>
      </div>
      <div class="flex items-center gap-4 text-sm text-text-sub-light dark:text-text-sub-dark">
        <div class="hidden sm:flex gap-4">
          <span id="token-stats-session">This Session: -</span>
          <span id="token-stats-total">Total: -</span>
        </div>
        <div class="flex gap-2">
          <button id="import-btn" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-xs font-medium">
            <span class="material-icons-outlined text-sm text-blue-500">file_upload</span>
            Import
          </button>
          <button id="export-btn" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors text-xs font-medium">
            <span class="material-icons-outlined text-sm text-blue-500">file_download</span>
            Export
          </button>
        </div>
      </div>
    </header>

    <div id="messages-wrapper" class="flex-1 overflow-y-auto flex flex-col items-center pb-40 px-4">
      <div id="welcome-screen" class="text-center max-w-2xl w-full animate-fade-in-up flex flex-col items-center justify-center h-full">
        <h1 class="text-4xl md:text-5xl font-bold text-text-main-light dark:text-white mb-4 tracking-tight">
          Bee <span class="font-normal text-text-main-light dark:text-gray-200">Personal AI Agent</span>
        </h1>
        <p class="text-text-sub-light dark:text-text-sub-dark text-lg mb-10 font-light">
          Select an agent and model below to start a new conversation.
        </p>
        <div class="flex flex-wrap justify-center gap-4 mb-12">
          <button id="welcome-new-chat" class="bg-primary hover:bg-primary-hover text-white px-8 py-3 rounded-lg font-medium shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5 flex items-center gap-2">
            <span>New Conversation</span>
          </button>
        </div>
        <div class="flex flex-wrap justify-center gap-3">
          <button class="suggestion-btn px-6 py-2.5 rounded-full bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark hover:border-blue-400 dark:hover:border-blue-500 hover:text-blue-600 dark:hover:text-blue-400 text-text-sub-light dark:text-text-sub-dark transition-colors shadow-sm text-sm">View Files</button>
          <button class="suggestion-btn px-6 py-2.5 rounded-full bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark hover:border-blue-400 dark:hover:border-blue-500 hover:text-blue-600 dark:hover:text-blue-400 text-text-sub-light dark:text-text-sub-dark transition-colors shadow-sm text-sm">Check Weather</button>
          <button class="suggestion-btn px-6 py-2.5 rounded-full bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark hover:border-blue-400 dark:hover:border-blue-500 hover:text-blue-600 dark:hover:text-blue-400 text-text-sub-light dark:text-text-sub-dark transition-colors shadow-sm text-sm">Search Knowledge</button>
          <button class="suggestion-btn px-6 py-2.5 rounded-full bg-white dark:bg-surface-dark border border-border-light dark:border-border-dark hover:border-blue-400 dark:hover:border-blue-500 hover:text-blue-600 dark:hover:text-blue-400 text-text-sub-light dark:text-text-sub-dark transition-colors shadow-sm text-sm">Write Code</button>
        </div>
      </div>
      
      <div id="messages" class="hidden w-full max-w-3xl py-8 space-y-6"></div>
    </div>

    <div id="input-area" class="absolute bottom-0 left-0 right-0 px-6 pb-4 pt-8 bg-gradient-to-t from-surface-light via-surface-light to-transparent dark:from-background-dark dark:via-background-dark">
      <div class="max-w-4xl mx-auto w-full">
        <div class="bg-white dark:bg-[#1a2233] rounded-2xl border border-gray-200 dark:border-gray-700 shadow-lg dark:shadow-xl overflow-visible focus-within:ring-2 focus-within:ring-blue-100 dark:focus-within:ring-blue-900/30 transition-shadow">
          <div class="px-4 pt-2 pb-0">
            <textarea id="message-input" 
              class="w-full resize-none border-0 bg-transparent py-1.5 px-2 text-text-main-light dark:text-text-main-dark placeholder-gray-400 dark:placeholder-gray-500 focus:ring-0 text-base max-h-36 overflow-y-auto min-h-[1.5rem]"
              placeholder="Type a message here, press ‚Üµ to send" 
              rows="1"></textarea>
          </div>
          
          <div class="px-3 py-2 flex items-center justify-between bg-transparent overflow-visible">
            <div class="flex items-center gap-2 overflow-x-auto no-scrollbar overflow-y-visible">
              <div class="relative">
                <button id="assistant-selector" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 text-xs font-medium text-text-sub-light dark:text-text-sub-dark transition-colors whitespace-nowrap">
                  <span id="selected-assistant">Auto Helper</span>
                  <span class="material-icons-outlined text-sm">expand_more</span>
                </button>
                <div id="assistant-dropdown" class="dropdown-menu"></div>
              </div>
              
              <div class="relative">
                <button id="model-selector" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 text-xs font-medium text-text-sub-light dark:text-text-sub-dark transition-colors whitespace-nowrap">
                  <span class="material-icons-outlined text-xs text-yellow-500">auto_awesome</span>
                  <span id="selected-model">Default (Config)</span>
                  <span class="material-icons-outlined text-sm">expand_more</span>
                </button>
                <div id="model-dropdown" class="dropdown-menu"></div>
              </div>
              
              <span class="text-xs text-gray-400 ml-2 hidden sm:inline-block">Shift+Enter for new line</span>
            </div>
            
            <div class="flex items-center gap-3 flex-shrink-0">
              <button id="mode-btn" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="Toggle theme">
                <span class="material-icons-outlined" id="mode-btn-icon">dark_mode</span>
              </button>
              <button id="config-btn" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="Config">
                <span class="material-icons-outlined">settings</span>
              </button>
              <button id="attach-btn" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-700" title="Attach file">
                <span class="material-icons-outlined rotate-45">attach_file</span>
              </button>
              <button id="expand-btn" class="p-2 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition-colors rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 hidden sm:block" title="Expand">
                <span class="material-icons-outlined">fullscreen</span>
              </button>
              <button id="send-btn" class="h-10 w-10 flex items-center justify-center rounded-xl bg-primary hover:bg-primary-hover text-white shadow-md hover:shadow-lg transition-all transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed ml-2">
                <span class="material-icons-outlined text-xl">arrow_upward</span>
              </button>
            </div>
          </div>
        </div>
        <p class="text-center text-xs text-gray-400 mt-2 dark:text-gray-600">AI can make mistakes. Consider checking important information.</p>
      </div>
    </div>
    
    <button id="scroll-bottom" class="scroll-bottom">
      <span class="material-icons-outlined">keyboard_arrow_down</span>
    </button>
  </main>

  <div id="toast-container" class="toast-container"></div>
  <div id="drag-overlay" class="drag-overlay">
    <div class="bg-white dark:bg-gray-800 border-2 border-dashed border-blue-500 rounded-2xl p-12 text-center">
      <span class="material-icons-outlined text-5xl text-blue-500 mb-4">cloud_upload</span>
      <p class="text-lg font-medium text-gray-700 dark:text-gray-200">Drop files here</p>
    </div>
  </div>
  <input type="file" id="file-input" class="hidden" multiple>

  <script>    // Theme management
    function initTheme() {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDark = savedTheme === 'dark' || (!savedTheme && prefersDark);
      if (isDark) document.documentElement.classList.add('dark');
      updateModeBtnText();
    }
    
    function toggleTheme() {
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
      updateModeBtnText();
    }
    
    function updateModeBtnText() {
      const icon = document.getElementById('mode-btn-icon');
      if (icon) icon.textContent = document.documentElement.classList.contains('dark') ? 'light_mode' : 'dark_mode';
    }

    // Auto-resize textarea
    function initTextarea() {
      const textarea = document.getElementById('message-input');
      
      if (!textarea) {
        console.error('Message input not found');
        return;
      }
      
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 192) + 'px';
        updateSendButton();
      });
      
      textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }
    
    function initKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + K to focus search
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
          e.preventDefault();
          document.getElementById('sidebar-search-btn').click();
        }
        
        // Escape to close search
        if (e.key === 'Escape') {
          const searchBox = document.getElementById('sidebar-search-box');
          if (!searchBox.classList.contains('hidden')) {
            searchBox.classList.add('hidden');
          }
          // Also close any open dropdowns
          document.querySelectorAll('.dropdown-menu').forEach(menu => {
            menu.classList.remove('active');
          });
        }
        
        // Ctrl/Cmd + N for new chat
        if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
          e.preventDefault();
          document.getElementById('new-chat-btn').click();
        }
      });
    }
    
    function updateSendButton() {
      const textarea = document.getElementById('message-input');
      const sendBtn = document.getElementById('send-btn');
      sendBtn.disabled = !textarea.value.trim();
    }

    // Dropdown management
    function initDropdowns() {
      const dropdowns = ['assistant', 'model'];
      dropdowns.forEach(type => {
        const btn = document.getElementById(`${type}-selector`);
        const menu = document.getElementById(`${type}-dropdown`);
        
        if (!btn || !menu) {
          console.warn(`Dropdown elements not found for ${type}`);
          return;
        }
        
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          dropdowns.forEach(t => {
            if (t !== type) {
              const otherMenu = document.getElementById(`${t}-dropdown`);
              if (otherMenu) otherMenu.classList.remove('active');
            }
          });
          const isOpen = !menu.classList.contains('active');
          menu.classList.toggle('active');
          if (isOpen) {
            if (type === 'assistant' && typeof renderAssistantDropdown === 'function') renderAssistantDropdown();
            if (type === 'model' && typeof renderModelDropdown === 'function') renderModelDropdown();
            const rect = btn.getBoundingClientRect();
            menu.style.left = rect.left + 'px';
            menu.style.bottom = (window.innerHeight - rect.top + 8) + 'px';
            menu.style.minWidth = Math.max(rect.width, 200) + 'px';
          }
        });
        
        // Prevent menu from closing when clicking inside it
        menu.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      });
      
      document.addEventListener('click', () => {
        dropdowns.forEach(type => {
          const menu = document.getElementById(`${type}-dropdown`);
          if (menu) menu.classList.remove('active');
        });
      });
    }

    // Session management
    let currentSessionId = null;
    let assistants = [];
    let models = [];
    let selectedAssistant = localStorage.getItem('bee_assistant') || 'auto';
    let selectedModel = localStorage.getItem('bee_model') || 'default';
    let isGenerating = false;

    async function loadSessions() {
      try {
        const response = await fetch('/api/sessions');
        const sessions = await response.json();
        renderSessions(sessions);
      } catch (e) {
        console.error('Failed to load sessions:', e);
      }
    }

    function renderSessions(sessions) {
      const list = document.getElementById('session-list');
      const empty = document.getElementById('empty-sessions');
      
      if (sessions.length === 0) {
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');
      
      const groups = groupSessionsByDate(sessions);
      
      list.innerHTML = Object.entries(groups).map(([date, items]) => `
        <div>
          <h3 class="px-4 text-xs font-semibold text-text-sub-light dark:text-text-sub-dark uppercase tracking-wider mb-2">${date}</h3>
          <ul class="space-y-1">
            ${items.map(session => {
              const safeId = escapeHtml(session.id);
              const safeTitle = escapeHtml(session.title);
              const isActive = session.id === currentSessionId;
              return `
              <li class="session-item ${isActive ? 'active' : ''}" data-id="${safeId}">
                <a href="#" class="flex items-start gap-3 px-4 py-3 rounded-lg hover:bg-white dark:hover:bg-gray-800 transition-colors group" onclick="loadSession('${safeId}'); return false;">
                  <span class="material-icons-outlined text-gray-400 mt-0.5 text-lg ${isActive ? 'text-blue-500' : ''}">chat_bubble${isActive ? '' : '_outline'}</span>
                  <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-text-main-light dark:text-text-main-dark truncate">${safeTitle}</p>
                    <div class="flex items-center justify-between mt-1">
                      <span class="text-xs text-text-sub-light dark:text-text-sub-dark">${session.message_count} msgs</span>
                      <span class="text-xs text-text-sub-light dark:text-text-sub-dark">${session.updated_at}</span>
                    </div>
                  </div>
                  <button class="delete-session-btn opacity-0 group-hover:opacity-100 p-1 hover:bg-red-100 dark:hover:bg-red-900 rounded transition-all" onclick="event.stopPropagation(); deleteSession('${safeId}')">
                    <span class="material-icons-outlined text-sm text-red-500">delete</span>
                  </button>
                </a>
              </li>
            `;}).join('')}
          </ul>
        </div>
      `).join('');
    }

    function groupSessionsByDate(sessions) {
      const groups = {};
      const today = new Date().toISOString().split('T')[0];
      const yesterday = new Date(Date.now() - 86400000).toISOString().split('T')[0];
      
      sessions.forEach(session => {
        let groupName;
        if (session.date === today) groupName = 'Today';
        else if (session.date === yesterday) groupName = 'Yesterday';
        else if (new Date(session.date) > new Date(Date.now() - 7 * 86400000)) groupName = 'This Week';
        else groupName = 'Earlier';
        
        if (!groups[groupName]) groups[groupName] = [];
        groups[groupName].push(session);
      });
      
      return groups;
    }

    async function loadSession(sessionId) {
      currentSessionId = sessionId;
      try {
        const response = await fetch(`/api/history?session_id=${sessionId}`);
        const data = await response.json();
        showChatInterface();
        renderMessages(data.messages);
        updateSessionTitle(data.messages);
        highlightCurrentSession();
      } catch (e) {
        showToast('Failed to load session', 'error');
      }
    }

    function showChatInterface() {
      document.getElementById('welcome-screen').classList.add('hidden');
      document.getElementById('messages').classList.remove('hidden');
    }

    function renderMessages(messages) {
      const container = document.getElementById('messages');
      container.innerHTML = messages.map(msg => renderMessage(msg)).join('');
      scrollToBottom();
    }

    function renderMessage(msg, isStreaming = false) {
      const isUser = msg.role === 'user';
      const content = isStreaming ? msg.content : marked.parse(msg.content);
      
      return `
        <div class="msg-row ${msg.role} ${isStreaming ? 'streaming' : ''}">
          <div class="w-full ${isUser ? 'flex justify-end items-start' : ''}">
            <div class="${isUser 
              ? 'bg-gray-100 dark:bg-gray-800 text-text-main-light dark:text-text-main-dark rounded-2xl rounded-br-md w-fit max-w-3xl group' 
              : 'bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl rounded-bl-md group'} 
              px-5 py-4 max-w-3xl shadow-sm">
              ${!isUser ? `
                <div class="flex items-center gap-2 mb-2">
                  <span class="material-icons-outlined text-blue-500">smart_toy</span>
                  <span class="text-sm font-medium text-text-sub-light dark:text-text-sub-dark">Bee</span>
                </div>
              ` : ''}
              <div class="message-content ${isStreaming ? 'streaming' : ''}">
                ${content}
              </div>
              <div class="flex items-center gap-2 mt-3 opacity-0 group-hover:opacity-100 transition-opacity">
                <button type="button" onclick="copyMessage(this)" class="p-1.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors" title="Â§çÂà∂">
                  <span class="material-icons-outlined text-sm">content_copy</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function updateSessionTitle(messages) {
      const firstUserMsg = messages.find(m => m.role === 'user');
      const title = firstUserMsg 
        ? firstUserMsg.content.substring(0, 50) + (firstUserMsg.content.length > 50 ? '...' : '')
        : 'New Chat';
      document.getElementById('current-session-title').textContent = title;
    }

    function highlightCurrentSession() {
      document.querySelectorAll('.session-item').forEach(item => {
        item.classList.toggle('active', item.dataset.id === currentSessionId);
      });
    }

    async function sendMessage() {
      const textarea = document.getElementById('message-input');
      const message = textarea.value.trim();
      if (!message || isGenerating) return;
      
      showChatInterface();
      
      const messagesContainer = document.getElementById('messages');
      messagesContainer.insertAdjacentHTML('beforeend', renderMessage({ role: 'user', content: message }));
      textarea.value = '';
      textarea.style.height = 'auto';
      updateSendButton();
      scrollToBottom();
      
      const loadingId = 'loading-' + Date.now();
      messagesContainer.insertAdjacentHTML('beforeend', `
        <div id="${loadingId}" class="msg-row assistant">
          <div class="w-full">
            <div class="bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl rounded-bl-md px-5 py-4 shadow-sm inline-flex items-center gap-2">
              <span class="material-icons-outlined text-blue-500">smart_toy</span>
              <div class="flex gap-1">
                <span class="w-2 h-2 bg-blue-500 rounded-full typing-dot"></span>
                <span class="w-2 h-2 bg-blue-500 rounded-full typing-dot"></span>
                <span class="w-2 h-2 bg-blue-500 rounded-full typing-dot"></span>
              </div>
            </div>
          </div>
        </div>
      `);
      scrollToBottom();
      
      isGenerating = true;
      updateSendButtonState();
      
      try {
        const response = await fetch('/api/chat/stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message,
            session_id: currentSessionId,
            assistant_id: selectedAssistant,
            model_id: selectedModel
          })
        });
        
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let assistantMessage = '';
        
        document.getElementById(loadingId).remove();
        
        const msgId = 'msg-' + Date.now();
        const streamStartTime = Date.now();
        let thinkingStartTime = null;
        messagesContainer.insertAdjacentHTML('beforeend', `
          <div id="${msgId}" class="msg-row assistant">
            <div class="w-full">
              <div class="bg-white dark:bg-gray-800 border border-gray-100 dark:border-gray-700 rounded-2xl rounded-bl-md px-5 py-4 max-w-3xl shadow-sm group">
                <div class="flex items-center justify-between gap-3 mb-2 flex-wrap">
                  <div class="flex items-center gap-2">
                    <span class="material-icons-outlined text-blue-500">smart_toy</span>
                    <span class="text-sm font-medium text-text-main-light dark:text-text-main-dark">Bee</span>
                  </div>
                  <div class="thinking-steps flex items-center gap-2" data-msg-id="${msgId}">
                    <div class="thinking-bar flex items-center gap-1" role="button" tabindex="0" title="Â±ïÁ§∫/ÈöêËóèÊÄùËÄÉËøáÁ®ã">
                      <span class="label"><span class="material-icons-outlined text-sm">psychology</span><span class="thinking-label">Â±ïÁ§∫Ê≠•È™§</span></span>
                      <span class="arrow">‚Ä∫</span>
                    </div>
                    <span class="duration text-xs text-text-sub-light dark:text-text-sub-dark">0s</span>
                  </div>
                </div>
                <div class="steps-content mb-3 hidden"></div>
                <div class="message-content streaming"></div>
                <div class="flex gap-2 mt-3 opacity-0 group-hover:opacity-100 transition-opacity">
                  <button type="button" onclick="copyMessage(this)" class="p-1.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors" title="Â§çÂà∂">
                    <span class="material-icons-outlined text-sm">content_copy</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `);
        
        const msgEl = document.getElementById(msgId);
        const msgContent = msgEl.querySelector('.message-content');
        const thinkingSteps = msgEl.querySelector('.thinking-steps');
        const stepsContent = msgEl.querySelector('.steps-content');
        const thinkingBar = msgEl.querySelector('.thinking-bar');
        const durationEl = msgEl.querySelector('.duration');
        const updateDuration = () => {
          const end = thinkingStartTime != null ? Date.now() : streamStartTime;
          const start = thinkingStartTime != null ? thinkingStartTime : streamStartTime;
          const sec = Math.round((end - start) / 1000);
          if (durationEl) durationEl.textContent = sec + 's';
        };
        const updateThinkingLabel = () => {
          const lb = msgEl.querySelector('.thinking-label');
          const isHidden = stepsContent.classList.contains('hidden');
          if (lb) lb.textContent = isHidden ? 'Â±ïÁ§∫Ê≠•È™§' : 'ÈöêËóèÊ≠•È™§';
          const arrow = msgEl.querySelector('.thinking-bar .arrow');
          if (arrow) arrow.style.transform = isHidden ? 'rotate(-90deg)' : 'none';
        };
        thinkingBar?.addEventListener('click', () => {
          stepsContent.classList.toggle('hidden');
          updateThinkingLabel();
        });
        
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          
          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();
          
          for (const line of lines) {
            if (!line.trim()) continue;
            try {
              const event = JSON.parse(line);
              if (event.type === 'session_id') {
                currentSessionId = event.session_id;
                loadSessions();
              } else if (event.type === 'assistant_dispatched') {
                selectedAssistant = event.assistant_id;
                document.getElementById('selected-assistant').textContent = event.assistant_name;
              } else if (event.type === 'message_chunk') {
                assistantMessage += event.text || '';
                msgContent.innerHTML = marked.parse(assistantMessage);
                scrollToBottom();
              } else if (event.type === 'stream') {
                assistantMessage += event.content || '';
                msgContent.innerHTML = marked.parse(assistantMessage);
                scrollToBottom();
              } else if (event.type === 'thinking' || event.type === 'thinking_content') {
                if (thinkingStartTime == null) thinkingStartTime = Date.now();
                const step = document.createElement('div');
                step.className = 'step-item';
                step.textContent = event.text || 'ÊÄùËÄÉ‰∏≠‚Ä¶';
                stepsContent.appendChild(step);
                updateDuration();
                scrollToBottom();
              } else if (event.type === 'tool_call') {
                if (thinkingStartTime == null) thinkingStartTime = Date.now();
                const step = document.createElement('div');
                step.className = 'step-item tool-call';
                step.textContent = 'üîß Ë∞ÉÁî®Â∑•ÂÖ∑: ' + (event.tool || '');
                stepsContent.appendChild(step);
                updateDuration();
                scrollToBottom();
              } else if (event.type === 'observation') {
                if (thinkingStartTime == null) thinkingStartTime = Date.now();
                const step = document.createElement('div');
                step.className = 'step-item observation';
                step.textContent = 'üëÅÔ∏è ËßÇÂØü ' + (event.tool || '') + ': ' + (event.preview || '').substring(0, 100);
                if ((event.preview || '').length > 100) step.textContent += '‚Ä¶';
                stepsContent.appendChild(step);
                updateDuration();
                scrollToBottom();
              } else if (event.type === 'tool_failure') {
                if (thinkingStartTime == null) thinkingStartTime = Date.now();
                const step = document.createElement('div');
                step.className = 'step-item recovery';
                step.textContent = '‚ö†Ô∏è Â∑•ÂÖ∑Â§±Ë¥• ' + (event.tool || '') + ': ' + (event.reason || '');
                stepsContent.appendChild(step);
                updateDuration();
                scrollToBottom();
              } else if (event.type === 'recovery') {
                if (thinkingStartTime == null) thinkingStartTime = Date.now();
                const step = document.createElement('div');
                step.className = 'step-item recovery';
                step.textContent = 'üîÑ ' + (event.detail || event.action || '');
                stepsContent.appendChild(step);
                updateDuration();
                scrollToBottom();
              } else if (event.type === 'error') {
                showToast(event.text || event.message || 'Error', 'error');
              }
            } catch (e) {
              console.error('Parse error:', e);
            }
          }
        }
        
        msgContent.innerHTML = marked.parse(assistantMessage);
        msgContent.classList.remove('streaming');
        updateDuration();
        if (stepsContent.children.length === 0) thinkingSteps.style.display = 'none';
        else updateThinkingLabel();
        hljs.highlightAll();
        
      } catch (e) {
        showToast('Failed to send message', 'error');
        document.getElementById(loadingId)?.remove();
      } finally {
        isGenerating = false;
        updateSendButtonState();
      }
    }

    function updateSendButtonState() {
      const sendBtn = document.getElementById('send-btn');
      sendBtn.innerHTML = isGenerating 
        ? '<span class="material-icons-outlined text-xl">stop</span>'
        : '<span class="material-icons-outlined text-xl">arrow_upward</span>';
    }

    function scrollToBottom() {
      const wrapper = document.getElementById('messages-wrapper');
      wrapper.scrollTop = wrapper.scrollHeight;
    }

    function initScrollButton() {
      const wrapper = document.getElementById('messages-wrapper');
      const btn = document.getElementById('scroll-bottom');
      
      wrapper.addEventListener('scroll', () => {
        const isNearBottom = wrapper.scrollHeight - wrapper.scrollTop - wrapper.clientHeight < 100;
        btn.classList.toggle('visible', !isNearBottom);
      });
      
      btn.addEventListener('click', scrollToBottom);
    }

    async function loadAssistants() {
      try {
        const response = await fetch('/api/assistants');
        if (!response.ok) throw new Error('Failed to fetch assistants');
        const list = await response.json();
        assistants = [{ id: 'auto', name: 'Auto Helper', description: 'Automatically select the best assistant' }, ...list];
        console.log('Loaded assistants:', assistants);
        renderAssistantDropdown();
      } catch (e) {
        console.error('Failed to load assistants:', e);
        // Fallback data
        assistants = [
          { id: 'auto', name: 'Auto Helper', description: 'Automatically select the best assistant' },
          { id: 'default', name: 'General Assistant', description: 'All-purpose AI assistant' }
        ];
        renderAssistantDropdown();
      }
    }

    async function loadModels() {
      try {
        const response = await fetch('/api/models');
        if (!response.ok) throw new Error('Failed to fetch models');
        models = await response.json();
        if (!models.some(m => m.id === 'default')) {
          models = [{ id: 'default', name: 'Default (Config)' }, ...models];
        }
        console.log('Loaded models:', models);
        renderModelDropdown();
      } catch (e) {
        console.error('Failed to load models:', e);
        // Fallback data
        models = [
          { id: 'default', name: 'Default (Config)' },
          { id: 'deepseek-chat', name: 'DeepSeek Chat' }
        ];
        renderModelDropdown();
      }
    }

    function renderAssistantDropdown() {
      const dropdown = document.getElementById('assistant-dropdown');
      dropdown.innerHTML = assistants.map(a => `
        <div class="dropdown-item ${a.id === selectedAssistant ? 'selected' : ''}" data-id="${a.id}" data-name="${a.name}">
          <span class="material-icons-outlined text-sm">psychology</span>
          <div>
            <div class="font-medium">${escapeHtml(a.name)}</div>
            <div class="text-xs opacity-70">${a.description ? escapeHtml(a.description) : ''}</div>
          </div>
        </div>
      `).join('');
      
      dropdown.querySelectorAll('.dropdown-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          selectedAssistant = item.dataset.id;
          localStorage.setItem('bee_assistant', selectedAssistant);
          document.getElementById('selected-assistant').textContent = item.dataset.name;
          dropdown.classList.remove('active');
          renderAssistantDropdown();
        });
      });
      const sel = document.getElementById('selected-assistant');
      if (sel) sel.textContent = assistants.find(a => a.id === selectedAssistant)?.name || selectedAssistant;
    }

    function renderModelDropdown() {
      const dropdown = document.getElementById('model-dropdown');
      dropdown.innerHTML = models.map(m => `
        <div class="dropdown-item ${m.id === selectedModel ? 'selected' : ''}" data-id="${m.id}" data-name="${m.name}">
          <span class="material-icons-outlined text-sm text-yellow-500">auto_awesome</span>
          <span>${escapeHtml(m.name)}</span>
        </div>
      `).join('');
      
      dropdown.querySelectorAll('.dropdown-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.stopPropagation();
          selectedModel = item.dataset.id;
          localStorage.setItem('bee_model', selectedModel);
          document.getElementById('selected-model').textContent = item.dataset.name;
          dropdown.classList.remove('active');
          renderModelDropdown();
        });
      });
      const selModel = document.getElementById('selected-model');
      if (selModel) selModel.textContent = models.find(m => m.id === selectedModel)?.name || selectedModel;
    }

    function initSearch() {
      const searchBtn = document.getElementById('sidebar-search-btn');
      const searchBox = document.getElementById('sidebar-search-box');
      const searchInput = document.getElementById('session-search-input');
      const clearBtn = document.getElementById('search-clear');
      
      searchBtn.addEventListener('click', () => {
        searchBox.classList.toggle('hidden');
        if (!searchBox.classList.contains('hidden')) {
          searchInput.focus();
        }
      });
      
      searchInput.addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        clearBtn.classList.toggle('hidden', !query);
        
        document.querySelectorAll('.session-item').forEach(item => {
          const title = item.querySelector('.truncate').textContent.toLowerCase();
          item.style.display = title.includes(query) ? '' : 'none';
        });
      });
      
      clearBtn.addEventListener('click', () => {
        searchInput.value = '';
        clearBtn.classList.add('hidden');
        document.querySelectorAll('.session-item').forEach(item => {
          item.style.display = '';
        });
      });
    }

    function initNewChat() {
      const newChatBtns = document.querySelectorAll('#new-chat-btn, #welcome-new-chat');
      newChatBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          currentSessionId = null;
          document.getElementById('messages').innerHTML = '';
          document.getElementById('messages').classList.add('hidden');
          document.getElementById('welcome-screen').classList.remove('hidden');
          document.getElementById('current-session-title').textContent = 'New Chat';
          highlightCurrentSession();
          document.getElementById('message-input').focus();
        });
      });
    }

    async function deleteSession(sessionId) {
      if (!confirm('Delete this conversation?')) return;
      
      try {
        await fetch('/api/session/clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: sessionId })
        });
        
        if (sessionId === currentSessionId) {
          currentSessionId = null;
          document.getElementById('messages').innerHTML = '';
          document.getElementById('messages').classList.add('hidden');
          document.getElementById('welcome-screen').classList.remove('hidden');
          document.getElementById('current-session-title').textContent = 'New Chat';
        }
        
        loadSessions();
        showToast('Conversation deleted', 'success');
      } catch (e) {
        showToast('Failed to delete conversation', 'error');
      }
    }

    function initSuggestions() {
      document.querySelectorAll('.suggestion-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.getElementById('message-input').value = btn.textContent.trim();
          document.getElementById('message-input').focus();
          updateSendButton();
        });
      });
    }

    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <span class="material-icons-outlined ${type === 'success' ? 'text-green-500' : type === 'error' ? 'text-red-500' : 'text-blue-500'}">
          ${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'info'}
        </span>
        <span>${message}</span>
      `;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function initDragAndDrop() {
      const overlay = document.getElementById('drag-overlay');
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        document.body.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      document.body.addEventListener('dragenter', () => overlay.classList.add('active'));
      overlay.addEventListener('dragleave', () => overlay.classList.remove('active'));
      overlay.addEventListener('drop', (e) => {
        overlay.classList.remove('active');
        const files = e.dataTransfer.files;
        handleFiles(files);
      });
    }

    function handleFiles(files) {
      showToast(`${files.length} file(s) attached`, 'success');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function copyMessage(btn) {
      const content = btn.closest('.msg-row').querySelector('.message-content').textContent;
      navigator.clipboard.writeText(content).then(() => {
        showToast('Copied to clipboard', 'success');
      });
    }

    document.getElementById('mode-btn')?.addEventListener('click', toggleTheme);

    document.getElementById('config-btn')?.addEventListener('click', () => {
      showToast('Configuration panel coming soon', 'info');
    });

    document.getElementById('expand-btn')?.addEventListener('click', () => {
      const textarea = document.getElementById('message-input');
      textarea.style.height = textarea.style.height === '300px' ? 'auto' : '300px';
    });

    document.getElementById('attach-btn')?.addEventListener('click', () => {
      document.getElementById('file-input').click();
    });

    document.getElementById('file-input')?.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        handleFiles(e.target.files);
      }
    });

    document.getElementById('export-btn')?.addEventListener('click', () => {
      showToast('Export functionality coming soon', 'info');
    });

    document.getElementById('import-btn')?.addEventListener('click', () => {
      showToast('Import functionality coming soon', 'info');
    });

    // Sidebar toggle
    function initSidebarToggle() {
      const toggle = document.getElementById('sidebar-toggle');
      const expandBtn = document.getElementById('sidebar-expand-btn');
      const newChatIcon = document.getElementById('sidebar-new-chat-icon');
      const sidebar = document.getElementById('sidebar');
      const newChatBtn = document.getElementById('new-chat-btn');
      
      function collapseSidebar() {
        if (window.innerWidth > 768) {
          sidebar.classList.add('collapsed');
        } else {
          sidebar.classList.remove('mobile-open');
        }
      }
      function expandSidebar() {
        if (window.innerWidth > 768) {
          sidebar.classList.remove('collapsed');
        } else {
          sidebar.classList.add('mobile-open');
        }
      }
      function toggleSidebar() {
        if (window.innerWidth > 768) {
          sidebar.classList.toggle('collapsed');
        } else {
          sidebar.classList.toggle('mobile-open');
        }
      }
      
      if (toggle) toggle.addEventListener('click', toggleSidebar);
      if (expandBtn) expandBtn.addEventListener('click', expandSidebar);
      if (newChatIcon && newChatBtn) newChatIcon.addEventListener('click', () => newChatBtn.click());
      const headerToggle = document.getElementById('header-sidebar-toggle');
      if (headerToggle) headerToggle.addEventListener('click', expandSidebar);
    }

    document.addEventListener('DOMContentLoaded', () => {
      console.log('Bee Chat initializing...');
      
      initTheme();
      initTextarea();
      initDropdowns();
      initScrollButton();
      initSearch();
      initNewChat();
      initSuggestions();
      initDragAndDrop();
      initSidebarToggle();
      initKeyboardShortcuts();
      
      // Test API endpoints
      console.log('Loading sessions, assistants, models...');
      loadSessions();
      loadAssistants();
      loadModels();
      
      document.getElementById('send-btn').addEventListener('click', sendMessage);
      
      console.log('Bee Chat initialized');
    });
  </script>
</body>
</html>
